

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pspace &mdash; pspace 0.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="pspace 0.1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">pspace 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pspace</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;pspace - a parameter space manager to create and maintain PBS jobs given the</span>
<span class="sd">combinations of predefined parameter values. Depends on the Portable Batch</span>
<span class="sd">System (PBS), thus is meant to be used on login servers of computer clusters</span>
<span class="sd">using PBS.</span>

<span class="sd">All commands expect one ore more configuration files as arguments.</span>

<span class="sd">Many commands can be interrupted by hitting CTRL-C on the keyboard.</span>

<span class="sd">For pspace to work, you need to create an executable script with the name</span>
<span class="sd">&quot;pspace&quot;, which is calling the function *call()*, like this:</span>

<span class="sd">    &gt;&gt;&gt; import sys, pspace</span>
<span class="sd">    &gt;&gt;&gt; if __name__ == &#39;__main__&#39;:</span>
<span class="sd">    &gt;&gt;&gt;     sys.exit(pspace.call())</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c">#</span>
<span class="c"># To do:</span>
<span class="c"># --&gt; in addition to PBS, also support pool? To make use of the tlab cluster</span>
<span class="c"># --&gt; define datatypes of parameters</span>
<span class="c"># --&gt; enable CMD_CHECKFILE, use to decide if &quot;create&quot; should be executed again</span>
<span class="c">#     (e.g. if parameter set cannot be loaded anymore, overwrite it)</span>
<span class="c">#</span>
<span class="n">__created__</span> <span class="o">=</span> <span class="s">&#39;2013-01-18&#39;</span>
<span class="n">__modified__</span> <span class="o">=</span> <span class="s">&#39;2014-07-02&#39;</span>

<span class="kn">import</span> <span class="nn">commands</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">progress</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">optparse2</span> <span class="kn">as</span> <span class="nn">optparse</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">optparse</span>


<span class="c">#=====================#</span>
<span class="c"># Command definitions #</span>
<span class="c">#=====================#</span>


<div class="viewcode-block" id="create"><a class="viewcode-back" href="../index.html#pspace.create">[docs]</a><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create datafiles, including the directory structure along the path.</span>

<span class="sd">    To create the datafiles, the command pattern CMD_FILE from the</span>
<span class="sd">    configuration file is used.</span>

<span class="sd">    In the typical usecase it is recommended to use the option --force to skip</span>
<span class="sd">    files that already exist and just &quot;fill the gaps&quot;.</span>

<span class="sd">    Use the --param option to select only a certain parameter subspace.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-21 - 2014-06-25</span>

    <span class="c"># parse command line options</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&#39;%prog create [options] CONFFILE &#39;</span> <span class="o">+</span>
                                     <span class="s">&#39;[CONFFILE2 ...]&#39;</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="n">__modified__</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">create</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--test&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;test mode, show files that would have been created&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;be verbose, report skipped files&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;be quiet, do not even report created files&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--param&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;filter parameters (define parameter subspace) in &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;the format &quot;A=1,B=:5,C=3.7:8.2&quot;&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--force&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;skip existing files, do not promt&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--bar&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;show progress bar&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-o&#39;</span><span class="p">,</span> <span class="s">&#39;--overwrite&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;overwrite parameter sets of existing files&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--help&#39;</span><span class="p">]</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">posargs</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">bar</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># remember shell&#39;s working directory</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># cycle all given configuration files</span>
        <span class="k">for</span> <span class="n">conffile</span> <span class="ow">in</span> <span class="n">conf_filenames</span><span class="p">(</span><span class="o">*</span><span class="n">posargs</span><span class="p">):</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">parse_conf</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
            <span class="n">psets</span> <span class="o">=</span> <span class="n">filter_psets</span><span class="p">(</span><span class="n">compute_psets</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="n">opts</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                                 <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">])</span>
            <span class="n">datafiles</span> <span class="o">=</span> <span class="n">psets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">datafiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c"># go to working directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">])</span>

            <span class="c"># cycle datafiles for every parameter combination</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">conffile</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">progress</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datafiles</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span> \
                    <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">datafiles</span><span class="p">:</span>
                    <span class="n">pset</span> <span class="o">=</span> <span class="n">psets</span><span class="p">[</span><span class="n">datafile</span><span class="p">]</span>

                    <span class="c">#if not opts.overwrite:</span>

                    <span class="c">### WTFFFF!!!!!!!</span>

                    <span class="c"># check if datafile already exists and check it</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
                        <span class="c">#if check_file(datafile):</span>
                        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">force</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">overwrite</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>
                        <span class="k">elif</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">overwrite</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                                <span class="s">&#39;pspace: create: cannot create file &#39;</span> <span class="o">+</span> \
                                <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: File exists&#39;</span> <span class="o">%</span> <span class="n">datafile</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c"># elif not os.path.isfile(datafile) and</span>
                    <span class="c"># os.path.exists(datafile):</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span> \
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
                        <span class="n">bar</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: create: not a file: &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">datafile</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c">#else:</span>
                        <span class="c">#if not os.path.isfile(datafile) \</span>
                                <span class="c">#and os.path.exists(datafile):</span>
                        <span class="c">#bar.end()</span>
                        <span class="c">#print &gt;&gt;sys.stderr, \</span>
                            <span class="c">#&#39;pspace: create: not a file: &quot;%s&quot;&#39; % datafile</span>
                        <span class="c">#sys.exit(1)</span>

                    <span class="c"># create missing directories along the path</span>
                    <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span> \
                                <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
                            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                                <span class="s">&#39;pspace: create: cannot create directory &#39;</span> <span class="o">+</span> \
                                <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: File exists&#39;</span> <span class="o">%</span> <span class="n">dirname</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>

                    <span class="c"># create file using template</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_file</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: create: would have &#39;</span> <span class="o">+</span>
                                         <span class="s">&#39;created datafile &quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">datafile</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">cmd</span><span class="o">+</span><span class="s">&#39; -O&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: create: created &#39;</span> <span class="o">+</span>
                                             <span class="s">&#39;datafile &quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">datafile</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                    <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;pspace: create: aborted by user&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># return to the shell&#39;s original working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="submit"><a class="viewcode-back" href="../index.html#pspace.submit">[docs]</a><span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Submit PBS jobs.</span>

<span class="sd">    For each parameter set, it will be checked first if there is already a</span>
<span class="sd">    process working on it (using *qstat*).</span>

<span class="sd">    Make sure to use *create* first to create missing datafiles and directories</span>
<span class="sd">    before submitting any jobs.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-21 - 2013-07-29</span>

    <span class="c"># parse command line options</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&#39;%prog submit [options] CONFFILE &#39;</span> <span class="o">+</span>
                                     <span class="s">&#39;[CONFFILE2 ...]&#39;</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="n">__modified__</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">submit</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="s">&#39;--number&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;number of jobs to submit. If negative, submit all&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-m&#39;</span><span class="p">,</span> <span class="s">&#39;--email&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;send email when job begins (b), ends (e) or aborts &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;(a)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-M&#39;</span><span class="p">,</span> <span class="s">&#39;--email-address&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;address&#39;</span><span class="p">,</span>
                  <span class="n">default</span><span class="o">=</span><span class="s">&#39;d.jung@jacobs-university.de&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set email address&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="s">&#39;--delay&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set delay between job submissions (in seconds)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-Q&#39;</span><span class="p">,</span> <span class="s">&#39;--queue&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;standard&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;set queue&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--test&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;test mode, just create job script, but do not &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;submit it&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;verbose mode&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;--ignore-acc&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;ignoreacc&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;ignore accuracy, do not look it up in the datafile&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--param&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;filter parameters (define parameter subspace) in &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;the format &quot;A=1,B=:5,C=3.7:8.2&quot;&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;be quiet, do not even report submitted jobs&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--force&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;skip jobs that cannot be submitted&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--sort&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;sort parameter sets by the given parameter&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-r&#39;</span><span class="p">,</span> <span class="s">&#39;--reverse&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;reverse sorting order&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--help&#39;</span><span class="p">]</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">posargs</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># remember shell&#39;s working directory</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c"># count the number of submitted jobs</span>
    <span class="n">submit_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># cycle all given configuration files</span>
        <span class="n">do_break</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">conffile</span> <span class="ow">in</span> <span class="n">conf_filenames</span><span class="p">(</span><span class="o">*</span><span class="n">posargs</span><span class="p">):</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">parse_conf</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
            <span class="n">psets</span> <span class="o">=</span> <span class="n">filter_psets</span><span class="p">(</span><span class="n">compute_psets</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="n">opts</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                                 <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">])</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">psets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">sort</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">key</span><span class="p">:</span> <span class="n">psets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">sort</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">reverse</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

            <span class="c"># go to working directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">])</span>

            <span class="c"># get queue information</span>
            <span class="n">qdata</span> <span class="o">=</span> <span class="n">get_qdata</span><span class="p">()</span>
            <span class="n">running</span> <span class="o">=</span> <span class="n">count_running</span><span class="p">(</span><span class="n">psets</span><span class="p">,</span> <span class="n">qdata</span><span class="p">)</span>
            <span class="n">diff_to_maxrun</span> <span class="o">=</span> <span class="bp">None</span> <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;MAXRUN&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span> \
                <span class="k">else</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;MAXRUN&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">running</span>

            <span class="c"># cycle jobs/datafiles</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                <span class="n">pset</span> <span class="o">=</span> <span class="n">psets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_exec</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">)</span>

                <span class="c"># check if the MAXRUN value has been reached</span>
                <span class="k">if</span> <span class="n">diff_to_maxrun</span> <span class="ow">and</span> <span class="n">submit_count</span> <span class="o">&gt;=</span> <span class="n">diff_to_maxrun</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;pspace: submit: reached MAXRUN value &#39;</span> <span class="o">+</span> \
                            <span class="s">&#39;(</span><span class="si">%i</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;MAXRUN&#39;</span><span class="p">]</span>
                        <span class="k">break</span>

                <span class="c"># check if the number of jobs to submit has been reached</span>
                <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">submit_count</span> <span class="o">&gt;=</span> <span class="n">opts</span><span class="o">.</span><span class="n">number</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="k">print</span> <span class="s">&#39;pspace: submit: reached number of jobs to &#39;</span> <span class="o">+</span> \
                            <span class="s">&#39;submit (</span><span class="si">%i</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">opts</span><span class="o">.</span><span class="n">number</span>
                    <span class="n">do_break</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>

                <span class="c"># make sure that the job is not already running</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">values</span><span class="p">()]:</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]:</span>
                                    <span class="k">break</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: submit: skipping &#39;</span> <span class="o">+</span>
                                             <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;, &#39;</span> <span class="o">%</span> <span class="n">key</span> <span class="o">+</span>
                                             <span class="s">&#39;already running (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">job_id</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: submit: cannot submit &quot;</span><span class="si">%s</span><span class="s">&quot;, &#39;</span> <span class="o">%</span> <span class="n">key</span> <span class="o">+</span> \
                            <span class="s">&#39;already running&#39;</span>  <span class="c"># (%s)% job_id</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c"># make sure that the datafile exists</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: submit: skipping &#39;</span> <span class="o">+</span>
                                             <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;, &#39;</span> <span class="o">%</span> <span class="n">key</span> <span class="o">+</span>
                                             <span class="s">&#39;datafile not found</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: submit: datafile &quot;</span><span class="si">%s</span><span class="s">&quot; not found&#39;</span> <span class="o">%</span> <span class="n">key</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c"># sleep for a certain delay</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>

                <span class="c"># check if target accuracy is already reached</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">ignoreacc</span><span class="p">:</span>
                    <span class="n">acc</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(</span><span class="n">get_acc</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                    <span class="n">acc_target</span> <span class="o">=</span> <span class="n">pset</span><span class="p">[</span><span class="s">&#39;ACC&#39;</span><span class="p">]</span>
                    <span class="n">acc_target</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">acc_target</span><span class="p">)</span> \
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">acc_target</span><span class="p">)</span> <span class="o">==</span> <span class="n">acc_target</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc_target</span><span class="p">)</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">]</span>  <span class="c"># pset[&#39;OP&#39;]  # can be &lt;, &gt;, &lt;=,</span>
                                                           <span class="c"># &gt;=, ==, !=</span>
                    <span class="n">comparison</span> <span class="o">=</span> <span class="n">compare</span><span class="p">(</span><span class="n">acc</span><span class="p">,</span> <span class="n">acc_target</span><span class="p">,</span> <span class="n">op</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">acc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">comparison</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                                <span class="s">&#39;pspace: submit: skipping &quot;</span><span class="si">%s</span><span class="s">&quot;, &#39;</span> <span class="o">%</span> <span class="n">key</span> <span class="o">+</span> \
                                <span class="s">&#39;target accuracy already reached (</span><span class="si">%g</span><span class="s">)&#39;</span> \
                                <span class="o">%</span> <span class="n">acc_target</span>
                        <span class="k">continue</span>

                <span class="c"># create temporary job script</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;job.temp&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="c"># write header</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#!/bin/sh</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

                    <span class="c"># set email options</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -m </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">opts</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">address</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -M </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">opts</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

                    <span class="c"># set job name</span>
                    <span class="c"># important! serves as identification of the job</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -N </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>

                    <span class="c"># set working directory</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -d </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">])</span>

                    <span class="c"># redirect standard output and standard error streams</span>
                    <span class="n">without_ext</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">key</span> <span class="k">else</span> <span class="n">key</span>
                    <span class="c">#without_ext_abs = os.path.abspath(without_ext)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -o eo-</span><span class="si">%s</span><span class="s">.out</span><span class="se">\n</span><span class="s">&#39;</span>
                            <span class="o">%</span> <span class="n">without_ext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -e eo-</span><span class="si">%s</span><span class="s">.err</span><span class="se">\n</span><span class="s">&#39;</span>
                            <span class="o">%</span> <span class="n">without_ext</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">))</span>

                    <span class="c"># set number of nodes and processors per node</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -l nodes=1:ppn=1</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>

                    <span class="c"># set queue</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">queue</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;#PBS -q </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">opts</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>

                    <span class="c">#f.write(&#39;#PBS -r n\n&#39;)  # do not rerun the job if it fails</span>

                    <span class="c"># append actual command</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cmd</span><span class="p">)</span>

                <span class="c"># submit the job script using &quot;qsub&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                    <span class="n">job_id</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;qsub job.temp&#39;</span><span class="p">,</span>
                                                     <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c"># report</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: submit: would have &#39;</span> <span class="o">+</span>
                                         <span class="s">&#39;submitted job &quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: submit: submitted job &#39;</span> <span class="o">+</span>
                                         <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">job_id</span><span class="p">))</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="c"># increase count</span>
                <span class="n">submit_count</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">do_break</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;pspace: submit: aborted by user&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># return to shell&#39;s original working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="delete"><a class="viewcode-back" href="../index.html#pspace.delete">[docs]</a><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete jobs submitted to the batch system. Filter by parameter subspace,</span>
<span class="sd">    node name or job ID.</span>

<span class="sd">    Uses the PBS command *qdel*.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-31 - 2013-07-29</span>

    <span class="c"># parse command line options</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&#39;%prog delete [options] CONFFILE &#39;</span> <span class="o">+</span>
                                     <span class="s">&#39;[CONFFILE2 ...]&#39;</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="n">__modified__</span><span class="p">,</span>
                               <span class="n">description</span><span class="o">=</span><span class="n">delete</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--param&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;filter by parameter subspace (valid example: &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;&quot;A=1,B=:5,C=3.7:8.2&quot;)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--test&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;test mode, just show which jobs would have been &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;deleted&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--force&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;never prompt&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-v&#39;</span><span class="p">,</span> <span class="s">&#39;--verbose&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;be verbose&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;be quiet, do not even report deleted jobs&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-W&#39;</span><span class="p">,</span> <span class="s">&#39;--delay&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set delay between the sending of the SIGTERM and &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;SIGKILL signals in seconds &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;(time that a job is granted to shutdown itself in a &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;controlled way)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-R&#39;</span><span class="p">,</span> <span class="s">&#39;--running&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;delete only running jobs (job status &quot;R&quot;)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-Q&#39;</span><span class="p">,</span> <span class="s">&#39;--queued&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;delete only queued jobs (job status &quot;Q&quot;)&#39;</span><span class="p">)</span>
    <span class="c">#op.add_option(&#39;-i&#39;, &#39;--id&#39;, default=None, type=int,</span>
                  <span class="c">#help=&#39;filter by job ID&#39;)</span>
    <span class="c">#op.add_option(&#39;-n&#39;, &#39;--node&#39;, default=&#39;&#39;, help=&#39;filter by node name&#39;)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--help&#39;</span><span class="p">]</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">posargs</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># remember shell&#39;s working directory</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">conffile</span> <span class="ow">in</span> <span class="n">conf_filenames</span><span class="p">(</span><span class="o">*</span><span class="n">posargs</span><span class="p">):</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">parse_conf</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
            <span class="n">psets</span> <span class="o">=</span> <span class="n">filter_psets</span><span class="p">(</span><span class="n">compute_psets</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="n">opts</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                                 <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">])</span>
            <span class="n">jobnames</span> <span class="o">=</span> <span class="n">psets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">jobnames</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c"># these have to be deleted</span>

            <span class="c"># go to working directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">])</span>

            <span class="c"># get queue information, get names of the jobs in the queue</span>
            <span class="n">qdata</span> <span class="o">=</span> <span class="n">get_qdata</span><span class="p">()</span>
            <span class="n">qjobs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">jobinfo</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="c"># filter according to job status</span>
                <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">running</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">queued</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">jobinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;job_state&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;R&#39;</span> \
                            <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">running</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">jobinfo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;job_state&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;Q&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">queued</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="n">qjobs</span><span class="p">[</span><span class="n">jobinfo</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">job_id</span>

            <span class="c"># cycle job names that have to be deleted (if found in queue)</span>
            <span class="k">for</span> <span class="n">jobname</span> <span class="ow">in</span> <span class="n">jobnames</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">jobname</span> <span class="ow">in</span> <span class="n">qjobs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c"># found a candidate</span>
                    <span class="n">job_id</span> <span class="o">=</span> <span class="n">qjobs</span><span class="p">[</span><span class="n">jobname</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">test</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: delete: would have &#39;</span> <span class="o">+</span>
                                             <span class="s">&#39;deleted job &#39;</span> <span class="o">+</span>
                                             <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">job_id</span><span class="p">))</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="k">continue</span>

                    <span class="c"># prompt</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">force</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;pspace: delete: delete job &#39;</span> <span class="o">+</span> \
                            <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; (</span><span class="si">%s</span><span class="s">) [</span><span class="si">%s</span><span class="s">]? &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span>
                                                  <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s">&#39;job_state&#39;</span><span class="p">])</span>
                        <span class="n">answer</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="n">message</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">answer</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&#39;yes&#39;</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">answer</span><span class="p">):</span>
                            <span class="k">continue</span>

                    <span class="c"># delete the job</span>
                    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;qdel -W</span><span class="si">%i</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span>
                                            <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">delay</span><span class="p">),</span>
                                               <span class="n">qjobs</span><span class="p">[</span><span class="n">jobname</span><span class="p">]),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: delete: deleted job &#39;</span> <span class="o">+</span>
                                         <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; (</span><span class="si">%s</span><span class="s">) [</span><span class="si">%s</span><span class="s">]</span><span class="se">\n</span><span class="s">&#39;</span>
                                         <span class="o">%</span> <span class="p">(</span><span class="n">jobname</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span>
                                            <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="s">&#39;job_state&#39;</span><span class="p">]))</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c">## selected job was not found in the queue</span>
                    <span class="c">#if not opts.force:</span>
                        <span class="c">#print &gt;&gt;sys.stderr, &#39;pspace: delete: job &quot;%s&quot; &#39; + \</span>
                            <span class="c">#&#39;not found&#39; % jobname</span>
                        <span class="c">#sys.exit(1)</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;pspace: delete: skipping &quot;</span><span class="si">%s</span><span class="s">&quot;, &#39;</span> <span class="o">+</span>
                                         <span class="s">&#39;job not found</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">jobname</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;pspace: delete: aborted by user&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># return to shell&#39;s original working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="info"><a class="viewcode-back" href="../index.html#pspace.info">[docs]</a><span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show information about a given configuration file and its parameter</span>
<span class="sd">    space.</span>

<span class="sd">    This command shows general information about a parameter space, i.e. one</span>
<span class="sd">    line per given configuration file. Use *list* to list information about</span>
<span class="sd">    every single parameter set, i.e., one line per parameter set.</span>

<span class="sd">    It can be specified which columns the output should contain (and their</span>
<span class="sd">    order) using the --display option. If --display contains a plus sign (+),</span>
<span class="sd">    all columns defined thereafter are added to the already defined (or</span>
<span class="sd">    default) columns. If --display contains a minus sign (-), all columns</span>
<span class="sd">    defined thereafter are removed from the already defined (or default)</span>
<span class="sd">    columns. For example, you can specify &quot;--display +db-c&quot; to add columns for</span>
<span class="sd">    the directory size and the working directory to the default output, but</span>
<span class="sd">    remove the cardinality column.</span>

<span class="sd">    Possible characters for the --display option:</span>

<span class="sd">    n</span>
<span class="sd">        name of the directory where the configuration file resides</span>
<span class="sd">    N</span>
<span class="sd">        relative path to the directory where the configuration file resides</span>
<span class="sd">    c</span>
<span class="sd">        cardinality (number of parameter combinations)</span>
<span class="sd">    e</span>
<span class="sd">        pattern for the execution command</span>
<span class="sd">    f</span>
<span class="sd">        pattern for creating the datafile</span>
<span class="sd">    a</span>
<span class="sd">        pattern for obtaining the accuracy</span>
<span class="sd">    o</span>
<span class="sd">        comparison operator used to decide if accuracy has been reached</span>
<span class="sd">    F</span>
<span class="sd">        pattern for the datafile</span>
<span class="sd">    M</span>
<span class="sd">        number of jobs being submitted at the same time (MAXRUN)</span>
<span class="sd">    d</span>
<span class="sd">        working directory (WORKDIR)</span>
<span class="sd">    D</span>
<span class="sd">        working directory (WORKDIR), absolute path</span>
<span class="sd">    b</span>
<span class="sd">        size of the directory (where the configuration file is in) in kilobytes</span>
<span class="sd">    s</span>
<span class="sd">        number of submitted jobs (no matter in which state)</span>
<span class="sd">    R</span>
<span class="sd">        number of running jobs (submitted and with status R)</span>
<span class="sd">    Q</span>
<span class="sd">        number of queued jobs (submitted and with status Q)</span>
<span class="sd">    C</span>
<span class="sd">        number of completed jobs (submitted and with status C)</span>
<span class="sd">    E</span>
<span class="sd">        number of exiting jobs (submitted and with status E)</span>
<span class="sd">    H</span>
<span class="sd">        number of held jobs (submitted and with status H)</span>
<span class="sd">    T</span>
<span class="sd">        number of moving jobs (submitted and with status T)</span>
<span class="sd">    W</span>
<span class="sd">        number of waiting jobs (submitted and with status W)</span>
<span class="sd">    S</span>
<span class="sd">        number of suspended jobs (submitted and with status S)</span>
<span class="sd">    t</span>
<span class="sd">        number of jobs that reached their target accuracy (so they finished)&quot;&quot;&quot;</span>
    <span class="c"># 2013-02-01 - 2014-07-02</span>

    <span class="c"># parse command line options</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&#39;%prog info [options] CONFFILE &#39;</span> <span class="o">+</span>
                                     <span class="s">&#39;[CONFFILE2 ...]&#39;</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="n">__modified__</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">info</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
    <span class="n">output_default</span> <span class="o">=</span> <span class="s">&#39;NcsRQ&#39;</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="s">&#39;--display&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;output&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">output_default</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set output columns (see documentation for possible &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;characters)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--titles&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;show column titles&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--columns&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set number of columns. If None, detect automatically&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--param&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;filter parameters (define parameter subspace) in &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;the format &quot;A=1,B=:5,C=3.7:8.2&quot;&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;be quiet, do not print warning that user aborted&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="s">&#39;--user&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">(),</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set user (job owner), defaults to current user&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--bar&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;show progress bar (only when fetching accuracy &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;information from the datafiles, i.e. --display &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;includes &quot;t&quot;)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-s&#39;</span><span class="p">,</span> <span class="s">&#39;--strict&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;do not skip configuration files with syntax errors&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--help&#39;</span><span class="p">]</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">posargs</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

    <span class="c"># understand output option</span>
    <span class="k">if</span> <span class="n">one_of_in</span><span class="p">(</span><span class="s">&#39;+-&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39;+-&#39;</span><span class="p">:</span>
            <span class="n">new_opt</span> <span class="o">=</span> <span class="n">output_default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span>
            <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">new_opt</span> <span class="o">+=</span> <span class="n">char</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">new_opt</span> <span class="o">=</span> <span class="n">new_opt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_opt</span> <span class="o">+=</span> <span class="n">char</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">new_opt</span>

    <span class="c"># remember shell&#39;s working directory</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c"># define column titles</span>
    <span class="n">ctitles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="s">&#39;CARDIN&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="s">&#39;CMD_EXEC&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="s">&#39;CMD_FILE&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="s">&#39;CMD_ACC&#39;</span><span class="p">,</span>
                   <span class="n">F</span><span class="o">=</span><span class="s">&#39;DATAFILE&#39;</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="s">&#39;MAXRUN&#39;</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="s">&#39;SIZE&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s">&#39;SUB&#39;</span><span class="p">,</span>
                   <span class="n">R</span><span class="o">=</span><span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="s">&#39;C&#39;</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="s">&#39;E&#39;</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="s">&#39;H&#39;</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="s">&#39;T&#39;</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="s">&#39;W&#39;</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="s">&#39;S&#39;</span><span class="p">,</span>
                   <span class="n">t</span><span class="o">=</span><span class="s">&#39;FINISHED&#39;</span><span class="p">,</span> <span class="n">D</span><span class="o">=</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="s">&#39;NAME&#39;</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">,</span>
                   <span class="n">N</span><span class="o">=</span><span class="s">&#39;RELPATH&#39;</span><span class="p">)</span>

    <span class="c"># get columns</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">get_cols</span><span class="p">()</span>

    <span class="c"># get queue data from the batch system using &quot;qstat -f1&quot;</span>
    <span class="c"># filter jobs of the specified user</span>
    <span class="k">if</span> <span class="n">one_of_in</span><span class="p">(</span><span class="s">&#39;sRQCEHTWS&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">):</span>
        <span class="n">qdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">get_qdata</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;Job_Owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">opts</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_info</span>

    <span class="c"># initialize data structures</span>
    <span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">conffile</span> <span class="ow">in</span> <span class="n">conf_filenames</span><span class="p">(</span><span class="o">*</span><span class="n">posargs</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conf</span> <span class="o">=</span> <span class="n">parse_conf</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">strict</span><span class="p">:</span>
                    <span class="k">raise</span>
                <span class="k">continue</span>
            <span class="n">psets</span> <span class="o">=</span> \
                <span class="n">filter_psets</span><span class="p">(</span><span class="n">compute_psets</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="n">opts</span><span class="o">.</span><span class="n">param</span><span class="p">,</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">])</span>
            <span class="n">datafiles</span> <span class="o">=</span> <span class="n">psets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">datafiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c"># initialize row datastructure</span>
            <span class="n">row_values</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># go to working directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">])</span>

            <span class="c"># fetch different types of information</span>
            <span class="k">if</span> <span class="n">one_of_in</span><span class="p">(</span><span class="s">&#39;sRQCEHTWS&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">):</span>
                <span class="c"># filter only qdata jobs of this configuration file</span>
                <span class="n">qdata_conf</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">datafiles</span><span class="p">:</span>
                        <span class="n">qdata_conf</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_info</span>

                <span class="c"># count how many jobs are in each state</span>
                <span class="n">state_count</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">R</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">C</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">E</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">W</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">S</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">qdata_conf</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">datafiles</span> \
                            <span class="ow">and</span> <span class="s">&#39;job_state&#39;</span> <span class="ow">in</span> <span class="n">job_info</span><span class="p">:</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;job_state&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">state_count</span><span class="p">:</span>
                            <span class="n">state_count</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="s">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="c"># get size of the directory</span>
                <span class="n">confdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dirsize</span> <span class="o">=</span> \
                        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;du -s </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">confdir</span><span class="p">,</span>
                                                <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>\
                        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="c">#print dirsize,</span>
                    <span class="n">dirsize</span> <span class="o">=</span> <span class="n">dirsize</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c">#print dirsize,</span>
                    <span class="n">dirsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dirsize</span><span class="p">)</span>  <span class="c"># float(dirsize)/1024</span>
                    <span class="c">#print dirsize</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">dirsize</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">if</span> <span class="s">&#39;n&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">conffile</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;N&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">conffile</span><span class="p">))</span>
            <span class="k">if</span> <span class="s">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="c"># obtain accuracy for all jobs, count how many have reached</span>
                <span class="c"># their target accuracy (i.e., how many are finished)</span>
                <span class="n">count_finished</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">conffile</span><span class="p">))</span>
                <span class="k">with</span> <span class="n">progress</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datafiles</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span>
                                  <span class="n">verbose</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">datafiles</span><span class="p">:</span>
                        <span class="n">pset</span> <span class="o">=</span> <span class="n">psets</span><span class="p">[</span><span class="n">datafile</span><span class="p">]</span>
                        <span class="n">acc</span> <span class="o">=</span> <span class="n">get_acc</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">)</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="n">pset</span><span class="p">[</span><span class="s">&#39;ACC&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">acc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">acc</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="p">:</span>
                            <span class="n">count_finished</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="c"># collect row values</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;N&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;c&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psets</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;e&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;F&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;M&#39;</span><span class="p">:</span>
                    <span class="n">maxrun</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;MAXRUN&#39;</span><span class="p">]</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxrun</span> <span class="k">if</span> <span class="n">maxrun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;d&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR_RAW&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;D&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dirsize</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qdata_conf</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;R&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;Q&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;C&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;E&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;H&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;T&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;W&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;S&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state_count</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span><span class="p">:</span>
                    <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count_finished</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                        <span class="s">&#39;pspace: info: unknown character &quot;</span><span class="si">%s</span><span class="s">&quot; in --display&#39;</span> \
                        <span class="o">%</span> <span class="n">char</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># collect values</span>
            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_values</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;pspace: info: aborted by user&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># return to shell&#39;s original working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

    <span class="c"># collect titles and column specifiers</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
        <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctitles</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
        <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

    <span class="c"># compute columnwidths</span>
    <span class="n">colwidths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">colindex</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)):</span>
        <span class="n">valwidths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row_values</span><span class="p">[</span><span class="n">colindex</span><span class="p">]))</span>
                     <span class="k">if</span> <span class="n">row_values</span><span class="p">[</span><span class="n">colindex</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">0</span>
                     <span class="k">for</span> <span class="n">row_values</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
        <span class="n">colwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valwidths</span><span class="p">)</span> <span class="k">if</span> <span class="n">valwidths</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">titles</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">colindex</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">colwidth</span><span class="p">:</span>
            <span class="n">colwidth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">colindex</span><span class="p">])</span>
        <span class="n">colwidths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colwidth</span><span class="p">)</span>

    <span class="c"># print information, even if incomplete (if aborted by user)</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">titles</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">colwidth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">titles</span><span class="p">,</span> <span class="n">colwidths</span><span class="p">):</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%- *s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="n">title</span><span class="p">))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">line</span><span class="p">[:(</span><span class="n">opts</span><span class="o">.</span><span class="n">columns</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">row_values</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">colwidth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row_values</span><span class="p">,</span> <span class="n">colwidths</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">% *s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="n">colwidth</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%- *s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">line</span><span class="p">[:(</span><span class="n">opts</span><span class="o">.</span><span class="n">columns</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

</div>
<div class="viewcode-block" id="jlist"><a class="viewcode-back" href="../index.html#pspace.jlist">[docs]</a><span class="k">def</span> <span class="nf">jlist</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List information about jobs.</span>

<span class="sd">    It can be specified which columns the output should contain (and their</span>
<span class="sd">    order) using the --display option. If --display contains a plus sign (+),</span>
<span class="sd">    all columns defined thereafter are added to the already defined (or</span>
<span class="sd">    default) columns. If --display contains a minus sign (-), all columns</span>
<span class="sd">    defined thereafter are removed from the already defined (or default)</span>
<span class="sd">    columns. For example, you can specify &quot;--display +Ab-i&quot; to add accuracy and</span>
<span class="sd">    filesize information to the default output, but remove the job ID column.</span>

<span class="sd">    Possible characters for the --display option:</span>

<span class="sd">    n</span>
<span class="sd">        job name (path to the associated datafile)</span>
<span class="sd">    i</span>
<span class="sd">        job ID (if job is currently submitted to the batch system)</span>
<span class="sd">    e</span>
<span class="sd">        execution command</span>
<span class="sd">    f</span>
<span class="sd">        command to create the datafile</span>
<span class="sd">    a</span>
<span class="sd">        command to obtain the data accuracy</span>
<span class="sd">    A</span>
<span class="sd">        current data accuracy (datafile lookup, costs time)</span>
<span class="sd">    t</span>
<span class="sd">        target accuracy</span>
<span class="sd">    p</span>
<span class="sd">        parameter set</span>
<span class="sd">    s</span>
<span class="sd">        PBS job state (if job is currently submitted to the batch system)</span>
<span class="sd">    b</span>
<span class="sd">        size of the datafile in kilobytes</span>

<span class="sd">    Possible characters for the --filter option:</span>
<span class="sd">    f</span>
<span class="sd">        show only finished jobs (already reached target accuracy)</span>
<span class="sd">    F</span>
<span class="sd">        show only unfinished jobs (not yet reached target accuracy)</span>
<span class="sd">    s</span>
<span class="sd">        show only jobs submitted to the batch system</span>
<span class="sd">    S</span>
<span class="sd">        show only jobs currently not submitted to the batch system</span>
<span class="sd">    r</span>
<span class="sd">        &quot;restart&quot;, same as &quot;FS&quot; (not finished and also currently not submitted</span>
<span class="sd">        to the batch system), i.e. these jobs should be restarted</span>
<span class="sd">    R</span>
<span class="sd">        show only running jobs (PBS job state &quot;R&quot;)</span>
<span class="sd">    Q</span>
<span class="sd">        show only queued jobs (PBS job state &quot;Q&quot;)</span>
<span class="sd">    C</span>
<span class="sd">        show only completed jobs (PBS job state &quot;C&quot;)</span>
<span class="sd">    E</span>
<span class="sd">        show only exited jobs (PBS job state &quot;E&quot;)</span>
<span class="sd">    H</span>
<span class="sd">        show only held jobs (PBS job state &quot;H&quot;)</span>
<span class="sd">    T</span>
<span class="sd">        show only moved jobs (PBS job state &quot;T&quot;)</span>
<span class="sd">    W</span>
<span class="sd">        show only waiting jobs (PBS job state &quot;W&quot;)</span>
<span class="sd">    P</span>
<span class="sd">        show only suspended jobs (PBS job state &quot;S&quot;)&quot;&quot;&quot;</span>
    <span class="c">#</span>
    <span class="c"># To do:</span>
    <span class="c"># --&gt; filter non-directories</span>
    <span class="c"># --&gt; automatically filter directories that do not contain a file named</span>
    <span class="c">#     &quot;pspace.conf&quot;</span>
    <span class="c">#</span>
    <span class="c"># 2013-02-02 - 2013-07-28</span>

    <span class="c"># parse command line options</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">optparse</span><span class="o">.</span><span class="n">OptionParser</span><span class="p">(</span><span class="n">usage</span><span class="o">=</span><span class="s">&#39;%prog list [options] CONFFILE &#39;</span> <span class="o">+</span>
                                     <span class="s">&#39;[CONFFILE2 ...]&#39;</span><span class="p">,</span>
                               <span class="n">version</span><span class="o">=</span><span class="n">__modified__</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">jlist</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
    <span class="n">output_default</span> <span class="o">=</span> <span class="s">&#39;nis&#39;</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-d&#39;</span><span class="p">,</span> <span class="s">&#39;--display&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;output&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">output_default</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set output columns (see documentation for possible &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;characters)&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-t&#39;</span><span class="p">,</span> <span class="s">&#39;--titles&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;show column titles&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-c&#39;</span><span class="p">,</span> <span class="s">&#39;--columns&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set number of columns. If None, detect automatically&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="s">&#39;--param&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;filter parameters (define parameter subspace) in &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;the format &quot;A=1,B=:5,C=3.7:8.2&quot;&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-q&#39;</span><span class="p">,</span> <span class="s">&#39;--quiet&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;be quiet, do not print warning that user aborted&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-u&#39;</span><span class="p">,</span> <span class="s">&#39;--user&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">(),</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;set user (job owner), defaults to current user&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-f&#39;</span><span class="p">,</span> <span class="s">&#39;--filter&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;define filter criteria&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span><span class="s">&#39;-b&#39;</span><span class="p">,</span> <span class="s">&#39;--bar&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                  <span class="n">help</span><span class="o">=</span><span class="s">&#39;show progress bar&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;--help&#39;</span><span class="p">]</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">posargs</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>

    <span class="c"># understand output option</span>
    <span class="k">if</span> <span class="n">one_of_in</span><span class="p">(</span><span class="s">&#39;+-&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="s">&#39;+-&#39;</span><span class="p">:</span>
            <span class="n">new_opt</span> <span class="o">=</span> <span class="n">output_default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_opt</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;+&#39;</span>
            <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
                    <span class="n">new_opt</span> <span class="o">+=</span> <span class="n">char</span>
                <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
                    <span class="n">new_opt</span> <span class="o">=</span> <span class="n">new_opt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_opt</span> <span class="o">+=</span> <span class="n">char</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">new_opt</span>

    <span class="c"># remember shell&#39;s working directory</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

    <span class="c"># define column titles</span>
    <span class="n">ctitles</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="s">&#39;NAME&#39;</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="s">&#39;ID&#39;</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="s">&#39;CMD_EXEC&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="s">&#39;CMD_FILE&#39;</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="s">&#39;CMD_ACC&#39;</span><span class="p">,</span>
                   <span class="n">A</span><span class="o">=</span><span class="s">&#39;ACC&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="s">&#39;TARGET&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="s">&#39;PSET&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s">&#39;STATE&#39;</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="s">&#39;SIZE&#39;</span><span class="p">)</span>

    <span class="c"># get columns</span>
    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">columns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">opts</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">get_cols</span><span class="p">()</span>

    <span class="c"># get queue data from the batch system using &quot;qstat -f1&quot;</span>
    <span class="c"># filter jobs of the specified user</span>
    <span class="k">if</span> <span class="n">one_of_in</span><span class="p">(</span><span class="s">&#39;is&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">)</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span><span class="p">:</span>
        <span class="n">qdata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">get_qdata</span><span class="p">()</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;Job_Owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">opts</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
                <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_info</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">conffile</span> <span class="ow">in</span> <span class="n">conf_filenames</span><span class="p">(</span><span class="o">*</span><span class="n">posargs</span><span class="p">):</span>
            <span class="n">conf</span> <span class="o">=</span> <span class="n">parse_conf</span><span class="p">(</span><span class="n">conffile</span><span class="p">)</span>
            <span class="n">psets</span> <span class="o">=</span> <span class="n">filter_psets</span><span class="p">(</span><span class="n">compute_psets</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="n">opts</span><span class="o">.</span><span class="n">param</span><span class="p">,</span>
                                 <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">])</span>
            <span class="n">datafiles</span> <span class="o">=</span> <span class="n">psets</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="n">datafiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

            <span class="c"># initialize data structures</span>
            <span class="n">titles</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c"># go to working directory</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">])</span>

            <span class="c"># cycle jobs/datafiles</span>
            <span class="n">dirname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">conffile</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">progress</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datafiles</span><span class="p">),</span> <span class="n">text</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">opts</span><span class="o">.</span><span class="n">bar</span><span class="p">)</span> \
                    <span class="k">as</span> <span class="n">bar</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">datafiles</span><span class="p">:</span>
                    <span class="n">pset</span> <span class="o">=</span> <span class="n">psets</span><span class="p">[</span><span class="n">datafile</span><span class="p">]</span>

                    <span class="c"># initialize row datastructure</span>
                    <span class="n">row_values</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c"># fetch different types of information</span>
                    <span class="k">if</span> <span class="s">&#39;b&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="c"># get size of the datafile</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">filesize</span> <span class="o">=</span> \
                                <span class="n">subprocess</span><span class="o">.</span>\
                                <span class="n">check_output</span><span class="p">(</span><span class="s">&#39;du -s </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">datafile</span><span class="p">,</span>
                                             <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="n">filesize</span> <span class="o">=</span> <span class="n">filesize</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">filesize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filesize</span><span class="p">)</span>  <span class="c"># float(dirsize)/1024</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">filesize</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">if</span> <span class="s">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="c"># get job ID</span>
                        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">datafile</span><span class="p">:</span>
                                <span class="c"># remember the variable job_id after the</span>
                                <span class="c"># for-loop has been left</span>
                                <span class="n">found_job_id</span> <span class="o">=</span> <span class="n">job_id</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># looks like the job is currently not submitted to</span>
                            <span class="c"># the batch system</span>
                            <span class="n">found_job_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">if</span> <span class="s">&#39;s&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span> <span class="ow">or</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span><span class="p">:</span>
                        <span class="c"># get job state</span>
                        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">job_info</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">datafile</span><span class="p">:</span>
                                <span class="n">job_state</span> <span class="o">=</span> <span class="n">job_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;job_state&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                                <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># looks like the job is currently not submitted to</span>
                            <span class="c"># the batch system</span>
                            <span class="n">job_state</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">if</span> <span class="s">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="c"># format parameter set</span>
                        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">]:</span>
                            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pname</span><span class="p">,</span> <span class="n">pset</span><span class="p">[</span><span class="n">pname</span><span class="p">]))</span>
                        <span class="n">parameter_set</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>

                    <span class="c"># filter option, part 1 (for which the accuracy is not</span>
                    <span class="c"># needed)</span>
                    <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span><span class="p">:</span>
                        <span class="c"># filter submitted/unsubmitted</span>
                        <span class="n">job_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">job_info</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]</span>
                                     <span class="k">for</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="s">&#39;s&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">job_names</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="s">&#39;S&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">job_names</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>

                        <span class="c"># filter by job state</span>
                        <span class="k">if</span> <span class="s">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;R&#39;</span> \
                                <span class="ow">or</span> <span class="s">&#39;Q&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;Q&#39;</span> \
                                <span class="ow">or</span> <span class="s">&#39;C&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;C&#39;</span> \
                                <span class="ow">or</span> <span class="s">&#39;E&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;E&#39;</span> \
                                <span class="ow">or</span> <span class="s">&#39;W&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;W&#39;</span> \
                                <span class="ow">or</span> <span class="s">&#39;H&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;H&#39;</span> \
                                <span class="ow">or</span> <span class="s">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;T&#39;</span> \
                                <span class="ow">or</span> <span class="s">&#39;P&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">job_state</span> <span class="o">!=</span> <span class="s">&#39;S&#39;</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>

                        <span class="c"># filter jobs that do not have to be restarted, part 1</span>
                        <span class="k">if</span> <span class="s">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">job_names</span><span class="p">:</span>
                            <span class="c"># job is currently running, so no need to restart</span>
                            <span class="c"># it right now</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>

                    <span class="c"># fetch additional information (get accuracy from datafile)</span>
                    <span class="k">if</span> <span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span> <span class="ow">or</span> <span class="n">one_of_in</span><span class="p">(</span><span class="s">&#39;fFr&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span><span class="p">):</span>
                        <span class="c"># obtain current data accuracy</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">data_accuracy</span> <span class="o">=</span> <span class="n">get_acc</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">data_accuracy</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

                    <span class="c"># filter option, part 2 (for which the accuracy has to be</span>
                    <span class="c"># known)</span>
                    <span class="k">if</span> <span class="n">one_of_in</span><span class="p">(</span><span class="s">&#39;fFr&#39;</span><span class="p">,</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span><span class="p">):</span>
                        <span class="c"># filter finished/unfinished</span>
                        <span class="n">finished</span> <span class="o">=</span> <span class="n">data_accuracy</span> \
                            <span class="ow">and</span> <span class="n">data_accuracy</span> <span class="o">&lt;=</span> <span class="n">pset</span><span class="p">[</span><span class="s">&#39;ACC&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s">&#39;f&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="s">&#39;F&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">finished</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>

                        <span class="c"># filter jobs that do not have to be restarted, part 2</span>
                        <span class="k">if</span> <span class="s">&#39;r&#39;</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">filter</span> <span class="ow">and</span> <span class="n">finished</span><span class="p">:</span>
                            <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                            <span class="k">continue</span>

                    <span class="c"># collect row values</span>
                    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;i&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">found_job_id</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;s&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_state</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;b&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filesize</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;e&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_exec</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;f&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_file</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd_acc</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;A&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_accuracy</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;t&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pset</span><span class="p">[</span><span class="s">&#39;ACC&#39;</span><span class="p">])</span>
                        <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="s">&#39;p&#39;</span><span class="p">:</span>
                            <span class="n">row_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameter_set</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                                <span class="s">&#39;pspace: list: unknown character &#39;</span> <span class="o">+</span> \
                                <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot; in --display&#39;</span> <span class="o">%</span> <span class="n">char</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c"># collect values</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_values</span><span class="p">)</span>
                    <span class="n">bar</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="c"># collect titles and column specifiers</span>
            <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
                <span class="n">titles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctitles</span><span class="p">[</span><span class="n">char</span><span class="p">])</span>
                <span class="n">chars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>

            <span class="c"># compute columnwidths</span>
            <span class="n">colwidths</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">colindex</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">)):</span>
                <span class="n">valwidths</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">row_values</span><span class="p">[</span><span class="n">colindex</span><span class="p">]))</span>
                             <span class="k">if</span> <span class="n">row_values</span><span class="p">[</span><span class="n">colindex</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="mi">0</span>
                             <span class="k">for</span> <span class="n">row_values</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
                <span class="n">colwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">valwidths</span><span class="p">)</span> <span class="k">if</span> <span class="n">valwidths</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">titles</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">colindex</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">colwidth</span><span class="p">:</span>
                    <span class="n">colwidth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="n">colindex</span><span class="p">])</span>
                <span class="n">colwidths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colwidth</span><span class="p">)</span>

            <span class="c"># print information, even if incomplete (if aborted by user)</span>
            <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">titles</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">colwidth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">titles</span><span class="p">,</span> <span class="n">colwidths</span><span class="p">):</span>
                    <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%- *s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="n">title</span><span class="p">))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">line</span><span class="p">[:(</span><span class="n">opts</span><span class="o">.</span><span class="n">columns</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">row_values</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">colwidth</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">row_values</span><span class="p">,</span> <span class="n">colwidths</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">% *s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                    <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">*</span><span class="n">colwidth</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%- *s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">colwidth</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="n">line</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span>
                <span class="k">print</span> <span class="n">line</span><span class="p">[:(</span><span class="n">opts</span><span class="o">.</span><span class="n">columns</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">opts</span><span class="o">.</span><span class="n">quiet</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;pspace: list: aborted by user&#39;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># return to shell&#39;s original working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="fnames"><a class="viewcode-back" href="../index.html#pspace.fnames">[docs]</a><span class="k">def</span> <span class="nf">fnames</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Show names (paths) of the datafiles for the selected jobs (which also</span>
<span class="sd">    serve as job names when submitted to the batch system).</span>

<span class="sd">    Shortcut for &quot;list --display n&quot;.</span>

<span class="sd">    Options are the same as for *list* except for the --display option having</span>
<span class="sd">    no effect. See the documentation of the *list* command for details&quot;&quot;&quot;</span>
    <span class="c"># 2013-02-02 - 2013-07-28</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;--display&#39;</span><span class="p">,</span> <span class="s">&#39;n&#39;</span><span class="p">)</span>
        <span class="n">jlist</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">fnames</span><span class="o">.</span><span class="n">__doc__</span>

</div>
<div class="viewcode-block" id="cardinality"><a class="viewcode-back" href="../index.html#pspace.cardinality">[docs]</a><span class="k">def</span> <span class="nf">cardinality</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute cardinality of the defined parameter space (number of parameter</span>
<span class="sd">    combinations).</span>

<span class="sd">    Shortcut for &quot;info --display a&quot;.</span>

<span class="sd">    Options are the same as for *info* except for the --display option having</span>
<span class="sd">    no effect. See the documentation of the *info* command for details.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-18 - 2013-07-28</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">args</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&#39;--display&#39;</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">cardinality</span><span class="o">.</span><span class="n">__doc__</span>

</div>
<div class="viewcode-block" id="purge"><a class="viewcode-back" href="../index.html#pspace.purge">[docs]</a><span class="k">def</span> <span class="nf">purge</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete empty datafiles. If directories end up empty, delete them as</span>
<span class="sd">    well.</span>

<span class="sd">    Datafiles of jobs that are currently submitted will be skipped.&quot;&quot;&quot;</span>
    <span class="c"># 2013-07-28 - 2013-07-28</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
    <span class="c">### problem: have to use external knowledge (how to use h5ls or something)</span>

    <span class="c">## parse command line options</span>
    <span class="c">#op = optparse.OptionParser(usage=&#39;%prog purge [options] CONFFILE &#39; +</span>
    <span class="c">#                                 &#39;[CONFFILE2 ...]&#39;,</span>
    <span class="c">#                           version=__modified__,</span>
    <span class="c">#                           description=purge.__doc__)</span>
    <span class="c">#op.add_option(&#39;-i&#39;, &#39;--ignore&#39;, default=&#39;__scell__,__param__,scell,param&#39;,</span>
    <span class="c">#              help=&#39;ignore given dataset names, i.e. purge even if &#39; +</span>
    <span class="c">#                   &#39;datasets with these names exist in the file&#39;)</span>
    <span class="c">##op.add_option(&#39;-n&#39;, &#39;--number&#39;, default=-1, type=int,</span>
    <span class="c">#              #help=&#39;number of datafiles to delete. If negative, delete &#39;</span>
    <span class="c">#              + #&#39;all&#39;)</span>
    <span class="c">##op.add_option(&#39;-d&#39;, &#39;--delay&#39;, default=0, type=float,</span>
    <span class="c">#              #help=&#39;set delay between file lookups (in seconds)&#39;)</span>
    <span class="c">##op.add_option(&#39;-t&#39;, &#39;--test&#39;, default=False, action=&#39;store_true&#39;,</span>
    <span class="c">#              #help=&#39;test mode, just list files which would have been &#39; +</span>
    <span class="c">#                   #&#39;deleted&#39;)</span>
    <span class="c">##op.add_option(&#39;-v&#39;, &#39;--verbose&#39;, default=False, action=&#39;store_true&#39;,</span>
    <span class="c">#              #help=&#39;verbose mode, report every deleted file&#39;)</span>
    <span class="c">#op.add_option(&#39;-p&#39;, &#39;--param&#39;, default=&#39;&#39;,</span>
    <span class="c">#              help=&#39;filter parameters (define parameter subspace) in &#39; +</span>
    <span class="c">#                   &#39;the format &quot;A=1,B=:5,C=3.7:8.2&quot;&#39;)</span>
    <span class="c">#if len(args) == 0:</span>
    <span class="c">#    args = [&#39;--help&#39;]</span>
    <span class="c">#opts, posargs = op.parse_args(args=list(args))</span>

    <span class="c">## remember shell&#39;s working directory</span>
    <span class="c">#cwd = os.getcwd()</span>

    <span class="c">## count the number of submitted jobs</span>
    <span class="c">#submit_count = 0</span>

    <span class="c">#try:</span>
    <span class="c">#    # cycle all given configuration files</span>
    <span class="c">#    do_break = False</span>
    <span class="c">#    for conffile in conf_filenames(*posargs):</span>
    <span class="c">#        conf = parse_conf(conffile)</span>
    <span class="c">#        psets = filter_psets(compute_psets(conf), opts.param,</span>
    <span class="c">#                             conf[&#39;pnames&#39;])</span>
    <span class="c">#        keys = psets.keys()</span>
    <span class="c">#        keys.sort()</span>

    <span class="c">#        # go to working directory</span>
    <span class="c">#        os.chdir(conf[&#39;WORKDIR&#39;])</span>

    <span class="c">#        # get queue information</span>
    <span class="c">#        qdata = get_qdata()</span>

    <span class="c">#    ### CONTINUE HERE ###</span>

    <span class="c">#    # cycle jobs/datafiles</span>
    <span class="c">#    for key in keys:</span>
    <span class="c">#        pset = psets[key]</span>
    <span class="c">#        cmd = cmd_exec(conf, pset)</span>

    <span class="c">#        # check if the MAXRUN value has been reached</span>
    <span class="c">#        if diff_to_maxrun and submit_count &gt;= diff_to_maxrun:</span>
    <span class="c">#            if not opts.quiet:</span>
    <span class="c">#                print &#39;pspace: submit: reached MAXRUN value &#39;+\</span>
    <span class="c">#                      &#39;(%i)&#39; % conf[&#39;MAXRUN&#39;]</span>
    <span class="c">#                break</span>

    <span class="c">#        # check if the number of jobs to submit has been reached</span>
    <span class="c">#        if opts.number &gt;= 0 and submit_count &gt;= opts.number:</span>
    <span class="c">#            if opts.verbose:</span>
    <span class="c">#                print &#39;pspace: submit: reached number of jobs to submit</span>
    <span class="c">#                (%i)&#39; \</span>
    <span class="c">#                    % opts.number</span>
    <span class="c">#            do_break = True</span>
    <span class="c">#            break</span>

    <span class="c">#        # make sure that the job is not already running</span>
    <span class="c">#        if key in [job[&#39;Job_Name&#39;] for job in qdata.values()]:</span>
    <span class="c">#            if opts.force:</span>
    <span class="c">#                    if opts.verbose:</span>
    <span class="c">#                        for job_id, job in qdata.iteritems():</span>
    <span class="c">#                            if key == job[&#39;Job_Name&#39;]:</span>
    <span class="c">#                                break</span>
    <span class="c">#                        sys.stdout.write(&#39;pspace: submit: skipping &quot;%s&quot;, &#39;</span>
    <span class="c">#                        % key +\ &#39;already running (%s)\n&#39; % job_id)</span>
    <span class="c">#                        sys.stdout.flush()</span>
    <span class="c">#                    continue</span>
    <span class="c">#            else:</span>
    <span class="c">#                print &gt;&gt;sys.stderr, \</span>
    <span class="c">#                    &#39;pspace: submit: cannot submit &quot;%s&quot;, &#39; % key +\</span>
    <span class="c">#                    &#39;already running&#39; # (%s)% job_id</span>
    <span class="c">#                sys.exit(1)</span>

    <span class="c">#        # make sure that the datafile exists</span>
    <span class="c">#        if not os.path.isfile(key):</span>
    <span class="c">#            if opts.force:</span>
    <span class="c">#                if opts.verbose:</span>
    <span class="c">#                    sys.stdout.write(&#39;pspace: submit: skipping &quot;%s&quot;,</span>
    <span class="c">#                    datafile &#39;+\ &#39;not found\n&#39; % key)</span>
    <span class="c">#                    sys.stdout.flush()</span>
    <span class="c">#                continue</span>
    <span class="c">#            else:</span>
    <span class="c">#                print &gt;&gt;sys.stderr, &#39;pspace: submit: datafile &quot;%s&quot; not</span>
    <span class="c">#                found&#39; % key</span>
    <span class="c">#                sys.exit(1)</span>

    <span class="c">#        # sleep for a certain delay</span>
    <span class="c">#        time.sleep(opts.delay)</span>

    <span class="c">#        # check if target accuracy is already reached</span>
    <span class="c">#        if not opts.ignoreacc:</span>
    <span class="c">#            acc = retry(get_acc, conf, pset, delay=2, retries=None)</span>
    <span class="c">#            acc_target = pset[&#39;ACC&#39;]</span>
    <span class="c">#            acc_target = int(acc_target) if int(acc_target) == acc_target</span>
    <span class="c">#            \ else float(acc_target)</span>
    <span class="c">#            op = conf[&#39;CMD_ACC_OP&#39;] #pset[&#39;OP&#39;] # can be &lt;, &gt;, &lt;=, &gt;=, ==,</span>
    <span class="c">#            !=</span>
    <span class="c">#            comparison = compare(acc, acc_target, op)</span>
    <span class="c">#            if acc is not None and comparison:</span>
    <span class="c">#                if opts.verbose:</span>
    <span class="c">#                    print &gt;&gt;sys.stderr, \</span>
    <span class="c">#                            &#39;pspace: submit: skipping &quot;%s&quot;, &#39; % key +\</span>
    <span class="c">#                            &#39;target accuracy already reached (%g)&#39; %</span>
    <span class="c">#                            acc_target</span>
    <span class="c">#                continue</span>

    <span class="c">#        # create temporary job script</span>
    <span class="c">#        with open(&#39;job.temp&#39;, &#39;w&#39;) as f:</span>
    <span class="c">#            # write header</span>
    <span class="c">#            f.write(&#39;#!/bin/sh\n&#39;)</span>

    <span class="c">#            # set email options</span>
    <span class="c">#            if opts.email:</span>
    <span class="c">#                f.write(&#39;#PBS -m %s\n&#39; % opts.email)</span>
    <span class="c">#            if opts.address:</span>
    <span class="c">#                f.write(&#39;#PBS -M %s\n&#39; % opts.address)</span>

    <span class="c">#            # set job name</span>
    <span class="c">#            # important! serves as identification of the job</span>
    <span class="c">#            f.write(&#39;#PBS -N %s\n&#39; % key)</span>

    <span class="c">#            # set working directory</span>
    <span class="c">#            f.write(&#39;#PBS -d %s\n&#39; % conf[&#39;WORKDIR&#39;])</span>

    <span class="c">#            # redirect standard output and standard error streams</span>
    <span class="c">#            without_ext = key.rsplit(&#39;.&#39;)[0] if &#39;.&#39; in key else key</span>
    <span class="c">#            #without_ext_abs = os.path.abspath(without_ext)</span>
    <span class="c">#            f.write(&#39;#PBS -o eo-%s.out\n&#39; % without_ext.replace(&#39;/&#39;, &#39;-&#39;))</span>
    <span class="c">#            f.write(&#39;#PBS -e eo-%s.err\n&#39; % without_ext.replace(&#39;/&#39;, &#39;-&#39;))</span>

    <span class="c">#            # set number of nodes and processors per node</span>
    <span class="c">#            f.write(&#39;#PBS -l nodes=1:ppn=1\n&#39;)</span>

    <span class="c">#            # set queue</span>
    <span class="c">#            if opts.queue: f.write(&#39;#PBS -q %s\n&#39; % opts.queue)</span>

    <span class="c">#            #f.write(&#39;#PBS -r n\n&#39;) # do not rerun the job if it fails</span>

    <span class="c">#            # append actual command</span>
    <span class="c">#            f.write(&#39;\n&#39;)</span>
    <span class="c">#            f.write(&#39;%s\n&#39; % cmd)</span>

    <span class="c">#        # submit the job script using &quot;qsub&quot;</span>
    <span class="c">#        if not opts.test:</span>
    <span class="c">#            job_id = subprocess.check_output(&#39;qsub job.temp&#39;,</span>
    <span class="c">#            shell=True).strip()</span>

    <span class="c">#        # report</span>
    <span class="c">#        if not opts.quiet:</span>
    <span class="c">#            if opts.test:</span>
    <span class="c">#                sys.stdout.write(&#39;pspace: submit: would have submitted job</span>
    <span class="c">#                &quot;%s&quot;\n&#39; \ % key)</span>
    <span class="c">#            else:</span>
    <span class="c">#                sys.stdout.write(&#39;pspace: submit: submitted job &quot;%s&quot;</span>
    <span class="c">#                (%s)\n&#39; \ % (key, job_id))</span>
    <span class="c">#            sys.stdout.flush()</span>

    <span class="c">#        # increase count</span>
    <span class="c">#        submit_count += 1</span>

    <span class="c">#    if do_break:</span>
    <span class="c">#        break</span>

    <span class="c">#except KeyboardInterrupt:</span>
    <span class="c">#    if not opts.quiet:</span>
    <span class="c">#        print &#39;pspace: submit: aborted by user&#39;</span>
    <span class="c">#finally:</span>
    <span class="c">#    # return to shell&#39;s original working directory</span>
    <span class="c">#    os.chdir(cwd)</span>

</div>
<div class="viewcode-block" id="users"><a class="viewcode-back" href="../index.html#pspace.users">[docs]</a><span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List job owners of submitted jobs.&quot;&quot;&quot;</span>
    <span class="c">#</span>
    <span class="c"># To do:</span>
    <span class="c"># --&gt; command line interface</span>
    <span class="c"># --&gt; sort options</span>
    <span class="c"># --&gt; filter options</span>
    <span class="c"># --&gt; use nice table output (write table module)</span>
    <span class="c">#</span>
    <span class="c"># 2013-08-09 - 2013-08-12</span>
    <span class="n">qdata</span> <span class="o">=</span> <span class="n">get_qdata</span><span class="p">()</span>
    <span class="n">userdata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">user</span><span class="p">,</span> <span class="n">project</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;Job_Owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">project</span> <span class="o">=</span> <span class="n">project</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">userdata</span><span class="p">:</span>
            <span class="n">userdata</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">project</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">queues</span><span class="o">=</span><span class="nb">set</span><span class="p">())</span>
        <span class="n">userdata</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="s">&#39;S&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;job_state&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;R&#39;</span><span class="p">:</span>
            <span class="n">userdata</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="s">&#39;R&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;Q&#39;</span><span class="p">:</span>
            <span class="n">userdata</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="s">&#39;Q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">userdata</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="s">&#39;queues&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;queue&#39;</span><span class="p">])</span>

    <span class="c"># display</span>
    <span class="kn">import</span> <span class="nn">table</span>
    <span class="k">print</span> <span class="n">table</span><span class="o">.</span><span class="n">dodtable</span><span class="p">(</span><span class="n">userdata</span><span class="p">,</span>  <span class="c"># maxwidth=80,</span>
                         <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;project&#39;</span><span class="p">,</span> <span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="s">&#39;queues&#39;</span><span class="p">])</span>

</div>
<div class="viewcode-block" id="queues"><a class="viewcode-back" href="../index.html#pspace.queues">[docs]</a><span class="k">def</span> <span class="nf">queues</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;List queues and their usage.&quot;&quot;&quot;</span>
    <span class="c">#</span>
    <span class="c"># To do:</span>
    <span class="c"># --&gt; command line interface</span>
    <span class="c"># --&gt; sort options</span>
    <span class="c"># --&gt; filter options</span>
    <span class="c"># --&gt; use nice table output (write table module)</span>
    <span class="c">#</span>
    <span class="c"># 2013-11-14 - 2013-11-14</span>
    <span class="n">qdata</span> <span class="o">=</span> <span class="n">get_qdata</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;queue&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">queue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">queue</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">S</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">R</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">users</span><span class="o">=</span><span class="nb">set</span><span class="p">())</span>
        <span class="n">data</span><span class="p">[</span><span class="n">queue</span><span class="p">][</span><span class="s">&#39;S&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;job_state&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;R&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">queue</span><span class="p">][</span><span class="s">&#39;R&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s">&#39;Q&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">queue</span><span class="p">][</span><span class="s">&#39;Q&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s">&#39;Job_Owner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data</span><span class="p">[</span><span class="n">queue</span><span class="p">][</span><span class="s">&#39;users&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="c"># display</span>
    <span class="kn">import</span> <span class="nn">table</span>
    <span class="k">print</span> <span class="n">table</span><span class="o">.</span><span class="n">dodtable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>  <span class="c"># maxwidth=80,</span>
                         <span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;S&#39;</span><span class="p">,</span> <span class="s">&#39;R&#39;</span><span class="p">,</span> <span class="s">&#39;Q&#39;</span><span class="p">,</span> <span class="s">&#39;users&#39;</span><span class="p">])</span>


<span class="c">#=====================#</span>
<span class="c"># Auxiliary functions #</span>
<span class="c">#=====================#</span>

</div>
<div class="viewcode-block" id="one_of_in"><a class="viewcode-back" href="../index.html#pspace.one_of_in">[docs]</a><span class="k">def</span> <span class="nf">one_of_in</span><span class="p">(</span><span class="n">sequence</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check if at least one item of the given sequence is contained in the</span>
<span class="sd">    given iterable.&quot;&quot;&quot;</span>
    <span class="c"># 2013-02-01 - 2013-02-01</span>
    <span class="c"># copied from pool (written 2012-09-25)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sequence</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="retry"><a class="viewcode-back" href="../index.html#pspace.retry">[docs]</a><span class="k">def</span> <span class="nf">retry</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Call the function *func* with the given arguments and keyword arguments.</span>
<span class="sd">    If an exception is raised, wait for a certain delay and call it again.</span>

<span class="sd">    Special keyword arguments:</span>

<span class="sd">    retries</span>
<span class="sd">        number of retries (default: 1), None means infinity</span>
<span class="sd">    delay</span>
<span class="sd">        delay before next try in seconds (default: 1)&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-31 - 2013-01-31</span>

    <span class="c"># fetch special keyword arguments</span>
    <span class="n">delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;delay&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">))</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;retries&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">retries</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">retries</span><span class="p">)</span> <span class="k">if</span> <span class="n">retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="bp">None</span>

    <span class="n">tries</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">while</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="n">retries</span> <span class="ow">or</span> <span class="n">retries</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">retries</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;=</span> <span class="n">retries</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="filter_psets"><a class="viewcode-back" href="../index.html#pspace.filter_psets">[docs]</a><span class="k">def</span> <span class="nf">filter_psets</span><span class="p">(</span><span class="n">psets</span><span class="p">,</span> <span class="n">opts_param</span><span class="p">,</span> <span class="n">pnames</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;From the given parameter sets *psets*, filter only those parameters that</span>
<span class="sd">    are specified in the given --param option string. Return the corresponding</span>
<span class="sd">    parameter subspace.  Only parameter names specified in the list *pnames*</span>
<span class="sd">    are allowed (if given).  Valid examples are &quot;J=1&quot;, &quot;J=1,L=10&quot;, &quot;J=7:,L=10&quot;,</span>
<span class="sd">    &quot;J=3:8,L=10&quot;.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-28 - 2013-02-11</span>

    <span class="c"># parse param option</span>
    <span class="n">filterparams</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">opts_param</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pair</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                <span class="s">&#39;pspace: bad NAME=VALUE pair &quot;</span><span class="si">%s</span><span class="s">&quot; in --param option&#39;</span> <span class="o">%</span> <span class="n">pair</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c"># check if this parameter has already occured</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">filterparams</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                <span class="s">&#39;pspace: double definition of parameter &quot;</span><span class="si">%s</span><span class="s">&quot; in &#39;</span> <span class="o">%</span> <span class="n">key</span> <span class="o">+</span> \
                <span class="s">&#39;--param option&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># check if this parameter has been decleared in the configuration file</span>
        <span class="k">if</span> <span class="n">pnames</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pnames</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                <span class="s">&#39;pspace: undecleared parameter &quot;</span><span class="si">%s</span><span class="s">&quot; in --param option&#39;</span> <span class="o">%</span> <span class="n">key</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># understand intervals</span>
        <span class="k">if</span> <span class="s">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                    <span class="s">&#39;pspace: bad interval definition &quot;</span><span class="si">%s</span><span class="s">&quot; in --param option&#39;</span> \
                    <span class="o">%</span> <span class="n">value</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">val1</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">val2</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val1</span><span class="p">)</span> <span class="k">if</span> <span class="n">val1</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: bad value &quot;</span><span class="si">%s</span><span class="s">&quot; in &#39;</span> <span class="o">%</span> <span class="n">val1</span> <span class="o">+</span> \
                    <span class="s">&#39;--param option&#39;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">val2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">val2</span><span class="p">)</span> <span class="k">if</span> <span class="n">val2</span> <span class="k">else</span> <span class="bp">None</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: bad value &quot;</span><span class="si">%s</span><span class="s">&quot; in &#39;</span> <span class="o">%</span> <span class="n">val2</span> <span class="o">+</span> \
                    <span class="s">&#39;--param option&#39;</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">filterparams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">filterparams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                    <span class="s">&#39;pspace: bad value &quot;</span><span class="si">%s</span><span class="s">&quot; in --param option&#39;</span> \
                    <span class="o">%</span> <span class="n">value</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># filter parameter sets</span>
    <span class="n">new_psets</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c">#keys = psets.keys()</span>
    <span class="c">#keys.sort()</span>
    <span class="c">#for key in keys:</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">pset</span> <span class="ow">in</span> <span class="n">psets</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="c">#pset = psets[key]</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># skip parameter sets which do not meet the filter criteria</span>
        <span class="k">for</span> <span class="n">pname</span><span class="p">,</span> <span class="n">pvalue</span> <span class="ow">in</span> <span class="n">filterparams</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pvalue</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="c"># interval given</span>
                <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="n">pvalue</span>
                <span class="k">if</span> <span class="n">val1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">val2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">val1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pset</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">val2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">val2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pset</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">val1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">pset</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">val1</span> <span class="ow">and</span> <span class="n">pset</span><span class="p">[</span><span class="n">pname</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">val2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># single number given</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">pset</span><span class="p">[</span><span class="n">pname</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pvalue</span><span class="p">):</span>
                    <span class="n">skip</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">skip</span><span class="p">:</span>
            <span class="c"># skip this parameter set as it does not meet the criteria</span>
            <span class="k">continue</span>

        <span class="c"># let this parameter set survive</span>
        <span class="n">new_psets</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">pset</span>

    <span class="c"># return new (possibly fewer) parameter sets</span>
    <span class="k">return</span> <span class="n">new_psets</span>

</div>
<div class="viewcode-block" id="count_running"><a class="viewcode-back" href="../index.html#pspace.count_running">[docs]</a><span class="k">def</span> <span class="nf">count_running</span><span class="p">(</span><span class="n">psets</span><span class="p">,</span> <span class="n">qdata</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count how many of the given parameter sets *psets* are running according</span>
<span class="sd">    to the given *qstat* output (*qdata*).&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-22 - 2013-01-22</span>
    <span class="n">running</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">job_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span><span class="p">[</span><span class="s">&#39;Job_Name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">qdata</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psets</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job_names</span><span class="p">:</span>
            <span class="n">running</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">running</span>

</div>
<div class="viewcode-block" id="get_acc"><a class="viewcode-back" href="../index.html#pspace.get_acc">[docs]</a><span class="k">def</span> <span class="nf">get_acc</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get accuracy from datafile.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-22 - 2013-02-01</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_acc</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                   <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c"># check if output is empty</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="c"># check if output can not be interpreted as a float</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># return float</span>
    <span class="k">return</span> <span class="n">output</span>

</div>
<div class="viewcode-block" id="check_file"><a class="viewcode-back" href="../index.html#pspace.check_file">[docs]</a><span class="k">def</span> <span class="nf">check_file</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check datafile. If the system call returns an empty string, return</span>
<span class="sd">    *False*, otherwise, return *True*.&quot;&quot;&quot;</span>
    <span class="c"># 2013-03-21 - 2013-03-21</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_check</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">retry</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                   <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span>
                   <span class="n">retries</span><span class="o">=</span><span class="n">retries</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">True</span> <span class="k">if</span> <span class="n">output</span> <span class="k">else</span> <span class="bp">False</span>

</div>
<div class="viewcode-block" id="cmd_file"><a class="viewcode-back" href="../index.html#pspace.cmd_file">[docs]</a><span class="k">def</span> <span class="nf">cmd_file</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the command needed to create the datafile associated with the</span>
<span class="sd">    given parameter set, using the template from the configuration file</span>
<span class="sd">    information.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-21 - 2013-01-21</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE_VALUES&#39;</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pset</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="cmd_exec"><a class="viewcode-back" href="../index.html#pspace.cmd_exec">[docs]</a><span class="k">def</span> <span class="nf">cmd_exec</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the execution command corresponding to the given parameter set,</span>
<span class="sd">    using the template from the configuration file information.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-21 - 2013-01-21</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC_VALUES&#39;</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pset</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="cmd_acc"><a class="viewcode-back" href="../index.html#pspace.cmd_acc">[docs]</a><span class="k">def</span> <span class="nf">cmd_acc</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the command needed to obtain the accuracy from the datafile</span>
<span class="sd">    corresponding to the given parameter set, using the template from the</span>
<span class="sd">    configuration file information.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-21 - 2013-01-21</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_VALUES&#39;</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pset</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="cmd_check"><a class="viewcode-back" href="../index.html#pspace.cmd_check">[docs]</a><span class="k">def</span> <span class="nf">cmd_check</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the command needed to check the integrity of a datafile, using</span>
<span class="sd">    the template from the configuration file information.&quot;&quot;&quot;</span>
    <span class="c"># 2013-03-21 - 2013-03-21</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_CHECKFILE_VALUES&#39;</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pset</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_CHECKFILE&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="get_qdata"><a class="viewcode-back" href="../index.html#pspace.get_qdata">[docs]</a><span class="k">def</span> <span class="nf">get_qdata</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get information about running jobs from PBS using the PBS command &quot;qstat</span>
<span class="sd">    -f1&quot;.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-22 - 2013-02-06</span>

    <span class="c"># get output from &quot;qstat -f1&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;qstat -f1&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c"># define keys and data types of a job record</span>
    <span class="n">job_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Job_Name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Job_Owner&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;resources_used.cput&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;resources_used.mem&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;resources_used.vmem&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;resources_used.walltime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;job_state&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;queue&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;server&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Checkpoint&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;ctime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;mtime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;qtime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;etime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Error_Path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;exec_host&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Hold_Types&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Join_Path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Keep_Files&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Mail_Points&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Mail_Users&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Output_Path&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Priority&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="s">&#39;Rerunable&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s">&#39;Resource_List.cput&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Resource_List.nodect&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Resource_List.nodes&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Resource_List.host&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Resource_List.mem&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Resource_List.walltime&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Resource_List.ncpus&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="s">&#39;session_id&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">&#39;submit_args&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;start_time&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;start_count&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="s">&#39;fault_tolerant&#39;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="s">&#39;submit_host&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;init_work_dir&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;Walltime.Remaining&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Shell_Path_List&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;Variable_List&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                <span class="s">&#39;interactive&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="s">&#39;exit_status&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">}</span>

    <span class="c"># parse output</span>
    <span class="n">qdata</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">line_index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
        <span class="c"># skip empty lines</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>

        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Job Id:&#39;</span><span class="p">):</span>
            <span class="c"># determine new job ID</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="n">words</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c"># initialize new job data structure</span>
            <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">keytype</span> <span class="ow">in</span> <span class="n">job_keys</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keytype</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">job_id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;job_id is empty&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">keytype</span> <span class="ow">in</span> <span class="n">job_keys</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">keytype</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                    <span class="s">&#39;pspace: warning: unknown output of &quot;qstat -f1&quot; in &#39;</span> <span class="o">+</span> \
                    <span class="s">&#39;line </span><span class="si">%i</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">line</span>
                <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">qdata</span><span class="p">[</span><span class="n">job_id</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c"># return the information</span>
    <span class="k">return</span> <span class="n">qdata</span>

</div>
<div class="viewcode-block" id="get_qdata_simple"><a class="viewcode-back" href="../index.html#pspace.get_qdata_simple">[docs]</a><span class="k">def</span> <span class="nf">get_qdata_simple</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get information about running jobs from PBS using the PBS command</span>
<span class="sd">    &quot;qstat&quot;.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-21 - 2013-01-22</span>

    <span class="c"># get output from &quot;qstat&quot;</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">&#39;qstat&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c"># parse output</span>
    <span class="n">qdata</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;Job&#39;</span> <span class="ow">or</span> <span class="n">words</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;--&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">job_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">time_use</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">words</span>
        <span class="n">job_id_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">job_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">job_id</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">job_id_host</span> <span class="o">=</span> <span class="n">job_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">job_id</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="n">qdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                          <span class="n">time_use</span><span class="o">=</span><span class="n">time_use</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="n">queue</span><span class="p">,</span>
                          <span class="n">job_id_num</span><span class="o">=</span><span class="n">job_id_num</span><span class="p">,</span> <span class="n">job_id_host</span><span class="o">=</span><span class="n">job_id_host</span><span class="p">))</span>

    <span class="c"># return the information</span>
    <span class="k">return</span> <span class="n">qdata</span>

</div>
<div class="viewcode-block" id="compute_psets"><a class="viewcode-back" href="../index.html#pspace.compute_psets">[docs]</a><span class="k">def</span> <span class="nf">compute_psets</span><span class="p">(</span><span class="n">conf</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute and return all possible parameter combinations (parameter sets)</span>
<span class="sd">    of the given configuration information *conf*, together with filename of</span>
<span class="sd">    the corresponding datafile and accuracy target.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-18 - 2013-07-28</span>

    <span class="n">pnames</span> <span class="o">=</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">]</span>
    <span class="n">psets</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c"># iterate over parameter space definitions (may overlap)</span>
    <span class="k">for</span> <span class="n">pspace</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">pcomb</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">pspace</span><span class="p">[</span><span class="s">&#39;values&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
                                         <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">pnames</span><span class="p">]):</span>
            <span class="n">pset</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="n">pnames</span><span class="p">,</span> <span class="n">pcomb</span><span class="p">):</span>
                <span class="n">pset</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">datafile</span> <span class="o">=</span> <span class="n">name_datafile</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">)</span>
            <span class="n">pset</span><span class="p">[</span><span class="s">&#39;ACC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pspace</span><span class="p">[</span><span class="s">&#39;acc&#39;</span><span class="p">]</span>
            <span class="c">#pset[&#39;OP&#39;] = pspace[&#39;op&#39;]</span>
            <span class="n">pset</span><span class="p">[</span><span class="s">&#39;FILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datafile</span>
            <span class="n">datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">datafile</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">):</span>
                <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">],</span>
                                                       <span class="n">datafile</span><span class="p">))</span>
                <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">],</span>
                                                       <span class="n">datafile</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">relpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
                <span class="n">abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
            <span class="n">pset</span><span class="p">[</span><span class="s">&#39;RELPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">relpath</span>
            <span class="n">pset</span><span class="p">[</span><span class="s">&#39;ABSPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">abspath</span>

            <span class="c"># check if this parameter combination (datafile name) is already in</span>
            <span class="c"># the list. If yes, choose the one with the better accuracy</span>
            <span class="k">if</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">psets</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">compare</span><span class="p">(</span><span class="n">psets</span><span class="p">[</span><span class="n">datafile</span><span class="p">][</span><span class="s">&#39;ACC&#39;</span><span class="p">],</span> <span class="n">pset</span><span class="p">[</span><span class="s">&#39;ACC&#39;</span><span class="p">],</span>
                           <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">]):</span>
                    <span class="k">continue</span>
            <span class="n">psets</span><span class="p">[</span><span class="n">datafile</span><span class="p">]</span> <span class="o">=</span> <span class="n">pset</span>

    <span class="c"># return parameter sets</span>
    <span class="k">return</span> <span class="n">psets</span>

</div>
<div class="viewcode-block" id="name_datafile"><a class="viewcode-back" href="../index.html#pspace.name_datafile">[docs]</a><span class="k">def</span> <span class="nf">name_datafile</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">pset</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determine the name of the datafile belonging to the given parameter set</span>
<span class="sd">    *pset*.  The configuration information *conf* must be given.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-21 - 2013-01-21</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE_VALUES&#39;</span><span class="p">]:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="nb">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">pset</span><span class="o">.</span><span class="n">copy</span><span class="p">()))</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE&#39;</span><span class="p">]</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;.h5&#39;</span>

</div>
<div class="viewcode-block" id="conf_filenames"><a class="viewcode-back" href="../index.html#pspace.conf_filenames">[docs]</a><span class="k">def</span> <span class="nf">conf_filenames</span><span class="p">(</span><span class="o">*</span><span class="n">fileobjects</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the (absolute) paths to the configuration file specified by either</span>
<span class="sd">    directory names or by the files themselves. If *force* is *True*, silently</span>
<span class="sd">    ignore invalid files and directories.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-18 - 2014-07-02</span>

    <span class="n">force</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;force&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="s">&#39;unknown keyword argument: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c">#filenames = []</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">fileobj</span> <span class="ow">in</span> <span class="n">fileobjects</span><span class="p">:</span>
        <span class="c"># check if file object exists at all</span>
        <span class="n">relpath</span> <span class="o">=</span> <span class="n">fileobj</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fileobj</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileobj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: no such file or directory&#39;</span> \
                <span class="o">%</span> <span class="n">relpath</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># handle the case if the file object is a directory</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">fileobj</span><span class="p">):</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
            <span class="c">#dirname = os.path.basename(fileobj)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileobj</span><span class="p">,</span> <span class="s">&#39;pspace.conf&#39;</span><span class="p">)</span>  <span class="c"># dirname+&#39;.conf&#39;</span>

        <span class="c"># check if name of the file is &quot;pspace.conf&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#39;pspace.conf&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: wrong filename&#39;</span> <span class="o">%</span> <span class="n">fileobj</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># check if file exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fileobj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: no such file&#39;</span> <span class="o">%</span> <span class="n">fileobj</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># return absolute path to configuration file</span>
        <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>

</div>
<div class="viewcode-block" id="parse_conf"><a class="viewcode-back" href="../index.html#pspace.parse_conf">[docs]</a><span class="k">def</span> <span class="nf">parse_conf</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load and parse a configuration file, given by *filename*. Return a</span>
<span class="sd">    configuration data structure. If a directory is given, look for a file</span>
<span class="sd">    named &lt;dirname&gt;.conf.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-18 - 2013-07-28</span>

    <span class="c"># define context constants</span>
    <span class="c">#NONE = None</span>
    <span class="n">PSPACE</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c"># initialize context flags</span>
    <span class="n">context</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">indent</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># get absolute path to the configuration file</span>
    <span class="n">filename</span><span class="p">,</span> <span class="o">=</span> <span class="n">conf_filenames</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c"># initialize data structure to hold configuration</span>
    <span class="n">conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">pnames</span><span class="o">=</span><span class="p">[],</span> <span class="n">MAXRUN</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">WORKDIR</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">DATAFILE</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">DATAFILE_VALUES</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">CMD_EXEC</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">CMD_EXEC_VALUES</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">CMD_FILE</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">CMD_FILE_VALUES</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">CMD_ACC</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">CMD_ACC_VALUES</span><span class="o">=</span><span class="p">[],</span> <span class="n">CMD_ACC_OP</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
                <span class="n">CMD_CHECKFILE</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">CMD_CHECKFILE_VALUES</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">pspaces</span><span class="o">=</span><span class="p">[])</span>

    <span class="c"># parse file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">lind</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()):</span>
            <span class="c"># skip empty lines</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="c"># has the context been left?</span>
            <span class="c">#print lind+1, context, line.strip(), line[0].isspace()</span>
            <span class="k">if</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c"># check indent</span>
            <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">indent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">indent</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()):</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: unexpected indent&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c"># inside contexts there are special rules</span>
            <span class="k">if</span> <span class="n">context</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># skip annotation lines</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="c"># cut off annotations at the end of the line</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="c"># parse parameter declarations</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;DECLARE&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]:</span>
                        <span class="n">pname</span> <span class="o">=</span> <span class="n">pname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pname</span><span class="p">:</span>
                            <span class="k">continue</span>

                        <span class="c"># check for already declared parameters</span>
                        <span class="k">if</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">]:</span>
                            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: &#39;</span> \
                                <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: parameter &quot;</span><span class="si">%s</span><span class="s">&quot; already declared&#39;</span> \
                                <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">pname</span><span class="p">)</span>
                            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                        <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pname</span><span class="p">)</span>

                <span class="c"># parse job submission limitations</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;MAXRUN&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">keyword</span><span class="p">,</span> <span class="n">number</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="n">number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">conf_syntax_error</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="p">)</span>

                    <span class="c"># check if number is positive</span>
                    <span class="k">if</span> <span class="n">number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: MAXRUN must be positive integer&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;MAXRUN&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: MAXRUN already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;MAXRUN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>

                <span class="c"># parse filename template</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;WORKDIR&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">workdir</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: WORKDIR already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">workdir</span><span class="p">))</span>
                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR_RAW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workdir</span>

                <span class="c"># parse filename template</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;DATAFILE&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">datafile</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: DATAFILE already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datafile</span>

                <span class="c"># parse filename values</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;DATAFILE_VALUES&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> \
                        <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE_VALUES&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: &#39;</span> \
                            <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: DATAFILE_VALUES already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE_VALUES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

                <span class="c"># parse execution command template</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_EXEC&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_EXEC already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>

                <span class="c"># parse execution command values</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_EXEC_VALUES&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> \
                        <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC_VALUES&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: &#39;</span> \
                            <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_EXEC_VALUES already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC_VALUES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

                <span class="c"># parse command template for creating the datafiles</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_FILE&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_FILE already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>

                <span class="c"># parse values for creating the datafiles</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_FILE_VALUES&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> \
                        <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE_VALUES&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: &#39;</span> \
                            <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_FILE_VALUES already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE_VALUES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

                <span class="c"># parse command template for checking datafiles</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_CHECKFILE&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_CHECKFILE&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_CHECKFILE already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_CHECKFILE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>

                <span class="c"># parse values for creating the datafiles</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_CHECKFILE_VALUES&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> \
                        <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_CHECKFILE_VALUES&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: &#39;</span> \
                            <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_CHECKFILE_VALUES already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_CHECKFILE_VALUES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

                <span class="c"># parse command template for getting the accuracy</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_ACC&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_ACC already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span>

                <span class="c"># parse values for getting the accuracy</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_ACC_VALUES&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> \
                        <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_VALUES&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_ACC_VALUES already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_VALUES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

                <span class="c"># parse command template for setting operator for comparison</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">op</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: CMD_ACC_OP already specified&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check if allowed symbol</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s">&#39;==&#39;</span><span class="p">,</span> <span class="s">&#39;!=&#39;</span><span class="p">):</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: unknown comparison operator&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">op</span>

                <span class="c"># parse parameter space definitions</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;PSPACE:&#39;</span><span class="p">:</span>
                    <span class="c"># enter context</span>
                    <span class="n">context</span> <span class="o">=</span> <span class="n">PSPACE</span>
                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="nb">dict</span><span class="p">(),</span> <span class="n">acc</span><span class="o">=</span><span class="bp">None</span><span class="p">))</span>

                <span class="c"># is there still something in that line? something unknown?</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="n">conf_syntax_error</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="p">)</span>

                <span class="c">### no else?</span>

            <span class="k">elif</span> <span class="n">context</span> <span class="ow">is</span> <span class="n">PSPACE</span><span class="p">:</span>
                <span class="c"># parse parameter values</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;PARAM&#39;</span><span class="p">:</span>
                    <span class="n">keyword</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ranges</span> <span class="o">=</span> \
                        <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">ranges</span> <span class="o">=</span> <span class="n">ranges</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="nb">range</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">range</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="nb">range</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">range</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="nb">range</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="nb">range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="bp">None</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">if</span> <span class="n">end</span> <span class="k">else</span> <span class="bp">None</span>
                            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">values</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">values</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">))</span>
                        <span class="k">elif</span> <span class="nb">range</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="nb">range</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                            <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="mi">0</span>
                            <span class="n">end</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">if</span> <span class="n">end</span> <span class="k">else</span> <span class="bp">None</span>
                            <span class="n">step</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="k">if</span> <span class="n">step</span> <span class="k">else</span> <span class="bp">None</span>
                            <span class="n">values</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">conf_syntax_error</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="p">)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;values&#39;</span><span class="p">]:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: values for parameter &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">+</span>\
                            <span class="s">&#39;already specified in this context&#39;</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;values&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>

                <span class="c"># parse target accuracy</span>
                <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;ACC&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">words</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                        <span class="c">#if len(words) == 2:</span>
                        <span class="n">keyword</span><span class="p">,</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">words</span>
                        <span class="c">#op = &#39;&lt;&#39;</span>
                        <span class="c">#elif len(words) == 3:</span>
                        <span class="c">#keyword, op, acc = words</span>

                        <span class="c"># convert value</span>
                        <span class="k">if</span> <span class="n">acc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;%&#39;</span><span class="p">):</span>
                            <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">100</span>
                        <span class="k">elif</span> <span class="n">acc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;ppm&#39;</span><span class="p">):</span>
                            <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mf">1e6</span>
                        <span class="k">elif</span> <span class="n">acc</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;ppb&#39;</span><span class="p">):</span>
                            <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span><span class="o">/</span><span class="mf">1e9</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">acc</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
                        <span class="c">#if float(acc) &lt; 1:</span>
                        <span class="c">#else:</span>
                            <span class="c">#acc = int(acc)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">conf_syntax_error</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="p">)</span>

                    <span class="c"># check if value is positive</span>
                    <span class="c"># not anymore! ACC can be any user-specified number that</span>
                    <span class="c"># serves as an abort criterion</span>
                    <span class="c">#if acc &lt;= 0:</span>
                        <span class="c">#print &gt;&gt;sys.stderr, \</span>
                            <span class="c">#&#39;pspace: %s:%i: ACC must be positive float&#39; \</span>
                            <span class="c">#% (filename, lind+1)</span>
                        <span class="c">#sys.exit(1)</span>

                    <span class="c"># check if already specified</span>
                    <span class="k">if</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;acc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: &#39;</span> \
                            <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: ACC already specified in this context&#39;</span> \
                            <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">lind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="c"># check operator</span>
                    <span class="c">#if op not in (&#39;&lt;&#39;, &#39;&gt;&#39;, &#39;&lt;=&#39;, &#39;&gt;=&#39;, &#39;==&#39;, &#39;!=&#39;):</span>
                        <span class="c">#print &gt;&gt;sys.stderr, \</span>
                            <span class="c">#&#39;pspace: %s:%i: bad operator&#39; \</span>
                            <span class="c">#% (filename, lind+1)</span>
                        <span class="c">#sys.exit(1)</span>

                    <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;acc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">acc</span>
                    <span class="c">#conf[&#39;pspaces&#39;][-1][&#39;op&#39;]  = op</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;unknown context (definitely a bug, please &#39;</span> <span class="o">+</span>
                                 <span class="s">&#39;report)&#39;</span><span class="p">)</span>

    <span class="c"># parsing finished, but make a few extra checks here</span>
    <span class="c"># check if undecleared parameters have been used in some parameter space</span>
    <span class="k">for</span> <span class="n">pspace</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">pspace</span><span class="p">[</span><span class="s">&#39;values&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">pname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">]:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: parameter &quot;</span><span class="si">%s</span><span class="s">&quot; undecleared&#39;</span> \
                                    <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pname</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c">## warn about decleared but unused parameters</span>
    <span class="c">#for pname in conf[&#39;pnames&#39;]:</span>
        <span class="c">#found = False</span>
        <span class="c">#for pspace in conf[&#39;pspaces&#39;]:</span>
            <span class="c">#if pname in pspace[&#39;values&#39;]:</span>
                <span class="c">#found = True</span>
                <span class="c">#break</span>
        <span class="c">#if found:</span>
            <span class="c">#continue</span>
        <span class="c">#print &#39;pspace: %s: warning: parameter &quot;%s&quot; decleared but never used&#39; \</span>
            <span class="c">#% (filename, pname)</span>

    <span class="c"># check if a target accuracy is specified for every parameter space</span>
    <span class="k">for</span> <span class="n">pspace</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">pspace</span><span class="p">[</span><span class="s">&#39;acc&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: missing ACC in PSPACE context&#39;</span> \
                                <span class="o">%</span> <span class="n">filename</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># check if every parameter has been used in each parameter space</span>
    <span class="k">for</span> <span class="n">pspace</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pspaces&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;pnames&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pname</span> <span class="ow">in</span> <span class="n">pspace</span><span class="p">[</span><span class="s">&#39;values&#39;</span><span class="p">]:</span>
                <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
                    <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: parameter &quot;</span><span class="si">%s</span><span class="s">&quot; missing in PSPACE context&#39;</span> \
                    <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pname</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># check if any command or filename templates are missing</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC&#39;</span><span class="p">]:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: missing CMD_ACC specification&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_EXEC&#39;</span><span class="p">]:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: missing CMD_EXEC specification&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_FILE&#39;</span><span class="p">]:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: missing CMD_FILE specification&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_CHECKFILE&#39;</span><span class="p">]:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: missing CMD_CHECKFILE specification&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;DATAFILE&#39;</span><span class="p">]:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
            <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">: missing DATAFILE specification&#39;</span> <span class="o">%</span> <span class="n">filename</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">]:</span>
        <span class="n">conf</span><span class="p">[</span><span class="s">&#39;WORKDIR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">)</span>
        <span class="c">#print &gt;&gt;sys.stderr, \</span>
            <span class="c">#&#39;pspace: %s: missing WORKDIR specification&#39; % filename</span>
        <span class="c">#sys.exit(1)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">]:</span>
        <span class="n">conf</span><span class="p">[</span><span class="s">&#39;CMD_ACC_OP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&lt;=&#39;</span>

    <span class="c"># return data structure holding the configuration information</span>
    <span class="k">return</span> <span class="n">conf</span>

</div>
<div class="viewcode-block" id="conf_syntax_error"><a class="viewcode-back" href="../index.html#pspace.conf_syntax_error">[docs]</a><span class="k">def</span> <span class="nf">conf_syntax_error</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">line_index</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exit on syntax error, providing the filename of the configuration file</span>
<span class="sd">    and the line number *line_index*.&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-18 - 2013-01-18</span>
    <span class="c">#raise</span>
    <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: </span><span class="si">%s</span><span class="s">:</span><span class="si">%i</span><span class="s">: syntax error&#39;</span> \
                        <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">line_index</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="printcols"><a class="viewcode-back" href="../index.html#pspace.printcols">[docs]</a><span class="k">def</span> <span class="nf">printcols</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">ret</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print the strings in the given list *strings* column-wise (similar to</span>
<span class="sd">    the Unix shell program *ls*), respecting the width of the terminal window.</span>
<span class="sd">    If *ret* is *True*, return the resulting string instead of printing it to</span>
<span class="sd">    *stdout*.&quot;&quot;&quot;</span>
    <span class="c"># 2012-09-26 - 2012-11-30</span>
    <span class="c"># based on tb.misc.printcols (written 2011-09-13)</span>
    <span class="c"># former tb.printcols from 2011-02-13 until 2011-08-02</span>
    <span class="c"># former mytools.printcols</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">numstr</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">get_cols</span><span class="p">()</span>
    <span class="n">maxwidth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_ansi_colors</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">])</span>
    <span class="n">numcols</span> <span class="o">=</span> <span class="n">cols</span><span class="o">/</span><span class="p">(</span><span class="n">maxwidth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">numrows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ceil</span><span class="p">(</span><span class="mf">1.</span><span class="o">*</span><span class="n">numstr</span><span class="o">/</span><span class="n">numcols</span><span class="p">))</span>

    <span class="c"># print the list</span>
    <span class="n">result</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">for</span> <span class="n">rind</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">numrows</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">cind</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">numcols</span><span class="p">):</span>
            <span class="n">sind</span> <span class="o">=</span> <span class="n">cind</span><span class="o">*</span><span class="n">numrows</span><span class="o">+</span><span class="n">rind</span>
            <span class="k">if</span> <span class="n">sind</span> <span class="o">&lt;</span> <span class="n">numstr</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">+=</span> <span class="n">strings</span><span class="p">[</span><span class="n">sind</span><span class="p">]</span> <span class="o">+</span> \
                    <span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="n">maxwidth</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">remove_ansi_colors</span><span class="p">(</span><span class="n">strings</span><span class="p">[</span><span class="n">sind</span><span class="p">]))</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>

    <span class="c"># return or print result</span>
    <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">result</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="remove_ansi_colors"><a class="viewcode-back" href="../index.html#pspace.remove_ansi_colors">[docs]</a><span class="k">def</span> <span class="nf">remove_ansi_colors</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove all ANSI color escape sequences from a string.&quot;&quot;&quot;</span>
    <span class="c"># 2012-11-30 - 2012-11-30</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;string expected&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\033</span><span class="s">[&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">string</span>
        <span class="n">string</span> <span class="o">=</span> <span class="n">string</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span><span class="o">+</span><span class="n">string</span><span class="p">[</span><span class="n">end</span><span class="p">:]</span>

</div>
<div class="viewcode-block" id="ceil"><a class="viewcode-back" href="../index.html#pspace.ceil">[docs]</a><span class="k">def</span> <span class="nf">ceil</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the ceiling of *x*. This exists purely as a substitute for</span>
<span class="sd">    *numpy.ceil*, to avoid the dependency on the *numpy* module.&quot;&quot;&quot;</span>
    <span class="c"># 2012-10-29 - 2012-10-29</span>
    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="n">x</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>

</div>
<div class="viewcode-block" id="get_cols"><a class="viewcode-back" href="../index.html#pspace.get_cols">[docs]</a><span class="k">def</span> <span class="nf">get_cols</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Try to get the width of the terminal window (will only work on Unix</span>
<span class="sd">    systems). If failing, return standard width (80 columns).&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">commands</span><span class="o">.</span><span class="n">getoutput</span><span class="p">(</span><span class="s">&#39;tput cols&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c"># return default width</span>
        <span class="k">return</span> <span class="mi">80</span>

</div>
<div class="viewcode-block" id="splits"><a class="viewcode-back" href="../index.html#pspace.splits">[docs]</a><span class="k">def</span> <span class="nf">splits</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">seps</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of the words in the given string, using the list of</span>
<span class="sd">    strings *seps* as delimiter strings. A *None* value in *seps* separates the</span>
<span class="sd">    string by whitespace of any length&quot;&quot;&quot;</span>
    <span class="c"># 2013-01-18 - 2013-01-18</span>
    <span class="c"># copied from tb.misc.splits (written 2012-07-15)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seps</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">seps</span> <span class="o">=</span> <span class="p">[</span><span class="n">seps</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">seps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">sep</span> <span class="ow">in</span> <span class="n">seps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">newparts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">newparts</span> <span class="o">+=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">newparts</span>
    <span class="k">return</span> <span class="n">parts</span>

</div>
<div class="viewcode-block" id="compare"><a class="viewcode-back" href="../index.html#pspace.compare">[docs]</a><span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">op</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compare two values using the given operator, which has to be one of the</span>
<span class="sd">    strings &quot;&lt;&quot;, &quot;&gt;&quot;, &quot;&lt;=&quot;, &quot;&gt;=&quot;, &quot;==&quot;, &quot;!=&quot;.&quot;&quot;&quot;</span>
    <span class="c"># 2013-06-25 - 2013-06-25</span>
    <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;&lt;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val1</span> <span class="o">&lt;</span> <span class="n">val2</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;&gt;&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val1</span> <span class="o">&gt;</span> <span class="n">val2</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;&lt;=&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val1</span> <span class="o">&lt;=</span> <span class="n">val2</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;&gt;=&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val1</span> <span class="o">&gt;=</span> <span class="n">val2</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;==&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val1</span> <span class="o">==</span> <span class="n">val2</span>
    <span class="k">elif</span> <span class="n">op</span> <span class="o">==</span> <span class="s">&#39;!=&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val1</span> <span class="o">!=</span> <span class="n">val2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;pspace: unknown operator &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">op</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="c">#==============#</span>
<span class="c"># Main program #</span>
<span class="c">#==============#</span>


<span class="c"># map commands (second element of sys.argv) to functions</span></div>
<span class="n">_cmd2func</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&#39;create&#39;</span><span class="p">:</span>    <span class="n">create</span><span class="p">,</span>      <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="n">create</span><span class="p">,</span>
    <span class="s">&#39;submit&#39;</span><span class="p">:</span>    <span class="n">submit</span><span class="p">,</span>      <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="n">submit</span><span class="p">,</span>
    <span class="s">&#39;delete&#39;</span><span class="p">:</span>    <span class="n">delete</span><span class="p">,</span>      <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="n">delete</span><span class="p">,</span>
    <span class="s">&#39;info&#39;</span><span class="p">:</span>      <span class="n">info</span><span class="p">,</span>        <span class="s">&#39;i&#39;</span><span class="p">:</span> <span class="n">info</span><span class="p">,</span>
    <span class="s">&#39;list&#39;</span><span class="p">:</span>      <span class="n">jlist</span><span class="p">,</span>       <span class="s">&#39;l&#39;</span><span class="p">:</span> <span class="n">jlist</span><span class="p">,</span>
    <span class="s">&#39;filenames&#39;</span><span class="p">:</span> <span class="n">fnames</span><span class="p">,</span>      <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="n">fnames</span><span class="p">,</span>
    <span class="s">&#39;cardin&#39;</span><span class="p">:</span>    <span class="n">cardinality</span><span class="p">,</span> <span class="s">&#39;n&#39;</span><span class="p">:</span> <span class="n">cardinality</span><span class="p">,</span>
    <span class="s">&#39;purge&#39;</span><span class="p">:</span>     <span class="n">purge</span><span class="p">,</span>       <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="n">purge</span><span class="p">,</span>
    <span class="s">&#39;users&#39;</span><span class="p">:</span>     <span class="n">users</span><span class="p">,</span>       <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">,</span>
    <span class="s">&#39;queues&#39;</span><span class="p">:</span>    <span class="n">queues</span><span class="p">,</span>      <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="n">queues</span>
    <span class="c">#&#39;faulty&#39;:    faulty,      &#39;y&#39;: faulty</span>
<span class="p">}</span>


<div class="viewcode-block" id="call"><a class="viewcode-back" href="../index.html#pspace.call">[docs]</a><span class="k">def</span> <span class="nf">call</span><span class="p">():</span>
    <span class="c"># 2013-01-18 - 2013-01-22</span>

    <span class="c"># return words for custom tab completion</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;--comp-words&#39;</span><span class="p">:</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">_cmd2func</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">filtered_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">filtered_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">print</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_keys</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c"># start GUI</span>
    <span class="c">#if len(sys.argv) == 2 and sys.argv[1] == &#39;--gui&#39;:</span>
        <span class="c">#sys.exit(start_gui())</span>

    <span class="c"># to enable custom tab completion, add the following lines to your .bashrc</span>
    <span class="c"># (see http://aplawrence.com/Unix/customtab.html#ixzz27bkFS2Y0):</span>
    <span class="c">#pspacewords=$(pspace --comp-words)</span>
    <span class="c">#_pspace()</span>
    <span class="c">#{</span>
        <span class="c">#local curw</span>
        <span class="c">#COMPREPLY=()</span>
        <span class="c">#curw=${COMP_WORDS[COMP_CWORD]}</span>
        <span class="c">#if [ $COMP_CWORD == 1 ]</span>
        <span class="c">#then</span>
            <span class="c">#COMPREPLY=($(compgen -W &#39;$pspacewords&#39; -- $curw))</span>
        <span class="c">#else</span>
            <span class="c">#COMPREPLY=($(compgen -A file -- $curw))</span>
        <span class="c">#fi</span>
        <span class="c">#return 0</span>
    <span class="c">#}</span>
    <span class="c">#complete -F _pspace -o dirnames pspace</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;-?&#39;</span><span class="p">,</span> <span class="s">&#39;--help&#39;</span><span class="p">):</span>
        <span class="c"># display help</span>
        <span class="n">cmds</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">_cmd2func</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span>
            <span class="k">if</span> <span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
                <span class="n">cmds</span><span class="p">[</span><span class="n">func</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;longs&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s">&#39;shorts&#39;</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cmds</span><span class="p">[</span><span class="n">func</span><span class="p">][</span><span class="s">&#39;shorts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmds</span><span class="p">[</span><span class="n">func</span><span class="p">][</span><span class="s">&#39;longs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="n">cmds</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="n">keys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">cmdstrings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmds</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">cmdstring</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s">&#39;longs&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cmdstring</span> <span class="o">+=</span> <span class="n">cmd</span><span class="p">[</span><span class="s">&#39;longs&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="s">&#39;shorts&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cmdstring</span> <span class="o">+=</span> <span class="s">&#39; (&#39;</span>
                    <span class="n">cmdstring</span> <span class="o">+=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">short</span> <span class="k">for</span> <span class="n">short</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s">&#39;shorts&#39;</span><span class="p">])</span>
                    <span class="n">cmdstring</span> <span class="o">+=</span> <span class="s">&#39;)&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmdstring</span> <span class="o">+=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">short</span> <span class="k">for</span> <span class="n">short</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">[</span><span class="s">&#39;shorts&#39;</span><span class="p">])</span>
            <span class="n">cmdstrings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmdstring</span><span class="p">)</span>

        <span class="k">print</span> <span class="n">__doc__</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&#39;Available commands (with shortcuts):&#39;</span>
        <span class="n">printcols</span><span class="p">(</span><span class="n">cmdstrings</span><span class="p">)</span>
        <span class="k">print</span>
        <span class="k">print</span> <span class="s">&#39;To get help to a specific command,&#39;</span><span class="p">,</span>
        <span class="k">print</span> <span class="s">&#39;use &quot;-?&quot;, e.g. &quot;pspace cardin -?&quot;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># execute command</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span> <span class="o">=</span> <span class="n">_cmd2func</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">print</span> <span class="o">&gt;&gt;</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">: command not found. &#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> \
                <span class="s">&#39;Type &quot;pspace -?&quot; for a list of pspace commands&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

</div>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">call</span><span class="p">()</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">pspace 0.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Daniel Jung.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>